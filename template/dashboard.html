<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoodDHub Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            min-height: 100vh;
            color: white;
            position: relative;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Christmas Lights Animation */
        .christmas-lights {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            z-index: 1000;
            pointer-events: none;
            overflow: hidden;
        }

        .light-string {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            height: 20px;
        }

        .light {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        .light:nth-child(1) { left: 5%; background: #ff0000; }
        .light:nth-child(2) { left: 15%; background: #00ff00; }
        .light:nth-child(3) { left: 25%; background: #0000ff; }
        .light:nth-child(4) { left: 35%; background: #ffff00; }
        .light:nth-child(5) { left: 45%; background: #ff00ff; }
        .light:nth-child(6) { left: 55%; background: #00ffff; }
        .light:nth-child(7) { left: 65%; background: #ffa500; }
        .light:nth-child(8) { left: 75%; background: #ff69b4; }
        .light:nth-child(9) { left: 85%; background: #32cd32; }
        .light:nth-child(10) { left: 95%; background: #8a2be2; }

        .light-wire {
            position: absolute;
            top: 17px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                #2a2a2a 0%, 
                #404040 25%, 
                #2a2a2a 50%, 
                #404040 75%, 
                #2a2a2a 100%
            );
            opacity: 0.6;
        }

        /* Christmas Theme Enhancements */
        .navbar {
            background: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 215, 0, 0.1);
            position: relative;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        /* Enhanced Hamburger Menu Styles */
        .menu-toggle {
            display: none;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite, pulse 2s ease-in-out infinite alternate;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.8rem 1rem;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 25px rgba(255, 107, 107, 0.4),
                0 4px 15px rgba(78, 205, 196, 0.3),
                0 0 20px rgba(69, 183, 209, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-toggle::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .menu-toggle:hover::before {
            transform: scale(1);
        }

        .menu-toggle:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 
                0 15px 35px rgba(255, 107, 107, 0.6),
                0 8px 25px rgba(78, 205, 196, 0.4),
                0 0 30px rgba(69, 183, 209, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            background-size: 500% 500%;
            border-color: rgba(255, 255, 255, 0.5);
        }

        .menu-toggle:active {
            transform: translateY(-1px) scale(1.05);
        }

        /* Glowing notification badge for menu button */
        .menu-toggle::after {
            content: '!';
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: bounce 2s ease-in-out infinite, glow 2s ease-in-out infinite alternate;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.8);
        }

        @keyframes pulse {
            from {
                box-shadow: 
                    0 8px 25px rgba(255, 107, 107, 0.4),
                    0 4px 15px rgba(78, 205, 196, 0.3),
                    0 0 20px rgba(69, 183, 209, 0.5);
            }
            to {
                box-shadow: 
                    0 12px 35px rgba(255, 107, 107, 0.6),
                    0 6px 25px rgba(78, 205, 196, 0.5),
                    0 0 30px rgba(69, 183, 209, 0.7);
            }
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 15px rgba(255, 71, 87, 0.8);
            }
            to {
                box-shadow: 0 0 25px rgba(255, 71, 87, 1);
            }
        }

        /* Menu text enhancements */
        .menu-toggle span {
            display: block;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .menu-toggle small {
            font-size: 0.6rem !important;
            margin-top: 2px !important;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            animation: twinkle 1.5s ease-in-out infinite alternate;
        }

        @keyframes twinkle {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }

            .nav-menu {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(25, 25, 25, 0.95);
                backdrop-filter: blur(20px);
                flex-direction: column;
                gap: 0;
                padding: 1rem;
                transform: translateY(-100vh);
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                border-top: 1px solid rgba(255, 215, 0, 0.3);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }

            .nav-menu.active {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }

            .nav-links {
                flex-direction: column;
                gap: 0;
                width: 100%;
            }

            .nav-link {
                padding: 1rem;
                width: 100%;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .hour-bonus-section {
                margin: 1rem 0;
                width: 100%;
                justify-content: center;
            }

            .logout-btn {
                margin-top: 1rem;
                width: 100%;
                text-align: center;
            }
        }

        .hour-bonus-section {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin: 0 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-glow {
            from {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            }
            to {
                box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
            }
        }

        .bonus-icon {
            font-size: 1.5rem;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }

        .bonus-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .bonus-title {
            font-weight: 700;
            color: white;
            font-size: 0.9rem;
        }

        .bonus-status {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .claim-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .claim-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .claim-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .welcome-text {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1rem 2rem;
            display: inline-block;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(79, 172, 254, 0.2);
            background: rgba(255, 255, 255, 0.2);
        }

        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.2), rgba(0, 242, 254, 0.1));
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1));
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .stat-card:hover::before {
            transform: translateX(100%);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .stat-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .quick-actions {
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .action-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(79, 172, 254, 0.3);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(79, 172, 254, 0.5);
        }

        .action-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .action-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .action-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .actions-menu-container {
            position: relative;
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        /* Christmas Snow Animation */
        .snowflake {
            position: absolute;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1em;
            animation: snowfall linear infinite;
            user-select: none;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Simple Christmas decorations */
        .christmas-decoration {
            position: fixed;
            font-size: 2rem;
            z-index: 999;
            user-select: none;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Simple Christmas ornaments - no animation */
        .christmas-ornament {
            position: fixed;
            font-size: 1.5rem;
            z-index: 998;
            user-select: none;
            pointer-events: none;
            opacity: 0.5;
        }

        .christmas-ornament:nth-child(1) { 
            top: 15%; 
            left: 5%; 
            color: #ff4757;
        }
        .christmas-ornament:nth-child(2) { 
            top: 25%; 
            right: 8%; 
            color: #2ed573;
        }


        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
            }

            .welcome-text {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .history-details {
                grid-template-columns: 1fr;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* Premium Action Button Styles */
        .action-btn, .claim-btn, .btn-primary, .cta-button {
            background: linear-gradient(135deg, #667eea, #764ba2, #4facfe, #00f2fe);
            background-size: 300% 300%;
            animation: gradientShift 4s ease infinite;
            color: white !important;
            border: none;
            padding: 14px 28px;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            text-decoration: none;
            display: inline-block;
            margin: 8px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 25px rgba(79, 172, 254, 0.4),
                0 4px 15px rgba(118, 75, 162, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn::before, .claim-btn::before, .btn-primary::before, .cta-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .action-btn:hover::before, .claim-btn:hover::before, .btn-primary:hover::before, .cta-button:hover::before {
            transform: scale(1);
        }

        .action-btn:hover, .claim-btn:hover, .btn-primary:hover, .cta-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                0 15px 35px rgba(79, 172, 254, 0.6),
                0 8px 25px rgba(118, 75, 162, 0.4),
                0 0 20px rgba(0, 242, 254, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            color: white !important;
            background-size: 400% 400%;
            border-color: rgba(255, 255, 255, 0.3);
            text-decoration: none;
        }

        .action-btn:active, .claim-btn:active, .btn-primary:active, .cta-button:active {
            transform: translateY(-1px) scale(1.02);
        }

        .action-btn:disabled, .claim-btn:disabled, .btn-primary:disabled, .cta-button:disabled {
            background: linear-gradient(135deg, #6c757d, #495057) !important;
            cursor: not-allowed;
            opacity: 0.7;
            animation: none;
            position: relative;
            overflow: hidden;
        }

        .action-btn:disabled::after, .claim-btn:disabled::after, .btn-primary:disabled::after, .cta-button:disabled::after {
            content: '🔒';
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .action-btn:disabled:hover, .claim-btn:disabled:hover, .btn-primary:disabled:hover, .cta-button:disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            background-size: 300% 300%;
        }

        /* Special styles for quiz and bonus buttons */
        button[onclick*="openLearnEarn"], button[onclick*="claimHourBonus"], 
        .learn-earn-button, .hour-bonus-button {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
        }

        button[onclick*="openLearnEarn"]:hover, button[onclick*="claimHourBonus"]:hover,
        .learn-earn-button:hover, .hour-bonus-button:hover {
            background-size: 500% 500%;
            box-shadow: 
                0 20px 40px rgba(255, 107, 107, 0.4),
                0 10px 30px rgba(78, 205, 196, 0.3),
                0 0 30px rgba(69, 183, 209, 0.4);
        }

        /* Enhanced hover effects for all buttons */
        button, .btn, input[type="submit"], input[type="button"] {
            transition: all 0.3s ease;
        }

        /* Forum and community buttons */
        .forum-btn, .community-btn, .post-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .forum-btn:hover, .community-btn:hover, .post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            color: white;
            text-decoration: none;
        }

        /* Hot Card Animation Styles */
        .hot-card {
            position: relative;
            overflow: hidden;
            animation: hotGlow 2s ease-in-out infinite alternate;
            border: 2px solid #ff6b6b !important;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 140, 0, 0.1)) !important;
        }

        .hot-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 107, 107, 0.3), transparent);
            transform: rotate(45deg);
            animation: hotShine 3s linear infinite;
        }

        .hot-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
            animation: hotBounce 1.5s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .hot-card:hover {
            transform: translateY(-8px) scale(1.02) !important;
            box-shadow: 
                0 25px 50px rgba(255, 107, 107, 0.4),
                0 15px 30px rgba(255, 140, 0, 0.3),
                0 0 30px rgba(255, 107, 107, 0.6) !important;
            border-color: #ff4757 !important;
        }

        @keyframes hotGlow {
            from {
                box-shadow: 
                    0 8px 25px rgba(255, 107, 107, 0.3),
                    0 4px 15px rgba(255, 140, 0, 0.2),
                    0 0 20px rgba(255, 107, 107, 0.4);
            }
            to {
                box-shadow: 
                    0 12px 35px rgba(255, 107, 107, 0.5),
                    0 6px 20px rgba(255, 140, 0, 0.3),
                    0 0 30px rgba(255, 107, 107, 0.6);
            }
        }

        @keyframes hotShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes hotBounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-2deg); }
            50% { transform: scale(1.05) rotate(1deg); }
            75% { transform: scale(1.08) rotate(-1deg); }
        }

        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                flex-direction: column;
                gap: 15px;
            }

            .page-title {
                font-size: 2rem;
            }

            .action-btn, .claim-btn, .btn-primary, .cta-button {
                padding: 12px 20px;
                font-size: 0.9rem;
                margin: 4px;
            }

            .hot-badge {
                font-size: 0.6rem;
                padding: 3px 6px;
                top: -6px;
                right: -6px;
            }
        }
    </style>
    <!-- Add Font Awesome for icons if needed -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Christmas Lights -->
    <div class="christmas-lights">
        <div class="light-wire"></div>
        <div class="light-string">
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
            <div class="light"></div>
        </div>
    </div>

    <!-- Floating Elements (Snowflakes and Ornaments) -->
    <div class="floating-elements">
        <!-- Snowflakes will be generated by JS -->
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <!-- Simple Christmas Decorations -->
    <div class="christmas-decoration" style="top: 10%; right: 10%;">🎄</div>
    <div class="christmas-decoration" style="bottom: 20%; left: 10%;">🎁</div>

    <!-- Simple Christmas Ornaments -->
    <div class="christmas-ornament">🌟</div>
    <div class="christmas-ornament">🔔</div>

    <nav class="navbar">
        <div class="nav-brand">💰 GoodDollar</div>

        <button class="menu-toggle" onclick="toggleMenu()" title="🎁 Click me to see the 12-hour bonus and Learn & Earn features!">
            <span id="menuIcon">☰</span>
            <small>🎁 Click me!</small>
        </button>

        <div class="nav-menu" id="navMenu">
            <!-- Hour Bonus Special Feature -->
            <div class="hour-bonus-section" id="hourBonusSection">
                <div class="bonus-icon">🎁</div>
                <div class="bonus-info">
                    <div class="bonus-title">12-Hour Bonus</div>
                    <div class="bonus-status" id="bonusStatus">Loading...</div>
                </div>
                <button class="claim-btn" id="claimBtn" onclick="claimHourBonus()" disabled>
                    Claim 50 G$
                </button>
            </div>

            <!-- Learn & Earn Countdown Timer -->
            <div class="hour-bonus-section" id="learnEarnSection" style="background: linear-gradient(45deg, #10b981, #059669); display: none;">
                <div class="bonus-icon">📚</div>
                <div class="bonus-info">
                    <div class="bonus-title">Learn & Earn</div>
                    <div class="bonus-status" id="learnEarnStatus">Loading...</div>
                </div>
                <button class="claim-btn" id="learnEarnBtn" onclick="openLearnEarn()" disabled>
                    Take Quiz
                </button>
            </div>

            <div class="nav-links">
                <a href="/overview" class="nav-link">Overview</a>
                <a href="/dashboard" class="nav-link" style="color: white; font-weight: 700;">Dashboard</a>
                <a href="/news" class="nav-link">News Feed</a>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="dashboard-header">
            <h1 class="welcome-text">Welcome Back!</h1>
            <div class="wallet-info">
                <strong>Wallet:</strong> {{ wallet[:8] }}...{{ wallet[-6:] }}
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-title">UBI Status</div>
                <div class="stat-value">Verified</div>
                <div class="stat-description">Recent claim confirmed on blockchain</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">💎</div>
                <div class="stat-title">GoodDollar Balance</div>
                <div class="stat-value" id="balanceValue">Loading...</div>
                <div class="stat-description" id="balanceDescription">Fetching from blockchain...</div>
            </div>

            <div class="stat-card" onclick="showForumNotifications()" style="cursor: pointer;">
                <div class="stat-icon" style="position: relative;">
                    💬
                    <div id="notificationBadge" style="
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        background: #ef4444;
                        color: white;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        font-size: 0.7rem;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                    ">0</div>
                </div>
                <div class="stat-title">Forum Rewards</div>
                <div class="stat-value" id="forumRewardsValue">Loading...</div>
                <div class="stat-description" id="forumRewardsDesc">Recent community earnings</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">🌟</div>
                <div class="stat-title">Community</div>
                <div class="stat-value">Global</div>
                <div class="stat-description">Part of worldwide UBI network</div>
            </div>
        </div>



        <div class="quick-actions">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 class="section-title" style="margin: 0;">Quick Actions</h2>
                <div class="actions-menu-container">
                    <button class="actions-menu-toggle" onclick="toggleActionsMenu()" style="
                        background: rgba(255, 255, 255, 0.15);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        padding: 0.8rem 1.2rem;
                        border-radius: 12px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" 
                       onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">
                        <span>📋 Choose Category</span>
                        <span id="menuArrow" style="transition: transform 0.3s ease;">▼</span>
                    </button>
                    <div class="actions-dropdown" id="actionsDropdown" style="
                        position: absolute;
                        top: 100%;
                        right: 0;
                        background: rgba(25, 25, 25, 0.95);
                        backdrop-filter: blur(20px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 12px;
                        padding: 0.5rem;
                        min-width: 220px;
                        display: none;
                        z-index: 100;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    ">
                        <div class="menu-item" onclick="filterActions('all')" style="
                            padding: 0.8rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            color: white;
                            transition: background 0.2s ease;
                            font-weight: 600;
                            background: linear-gradient(45deg, #4facfe, #00f2fe);
                        " onmouseover="if(!this.classList.contains('active')) this.style.background='rgba(255, 255, 255, 0.1)'" 
                           onmouseout="if(!this.classList.contains('active')) this.style.background='transparent'">
                            🌟 Show All Actions
                        </div>
                        <div class="menu-item" onclick="filterActions('earning')" style="
                            padding: 0.8rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            color: white;
                            transition: background 0.2s ease;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                           onmouseout="this.style.background='transparent'">
                            💰 Earning & Rewards
                        </div>
                        <div class="menu-item" onclick="filterActions('financial')" style="
                            padding: 0.8rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            color: white;
                            transition: background 0.2s ease;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                           onmouseout="this.style.background='transparent'">
                            💳 Financial Services
                        </div>
                        <div class="menu-item" onclick="filterActions('social')" style="
                            padding: 0.8rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            color: white;
                            transition: background 0.2s ease;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                           onmouseout="this.style.background='transparent'">
                            👥 Social & Community
                        </div>
                        <div class="menu-item" onclick="filterActions('analytics')" style="
                            padding: 0.8rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            color: white;
                            transition: background 0.2s ease;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                           onmouseout="this.style.background='transparent'">
                            📊 Analytics & Tracking
                        </div>
                    </div>
                </div>
            </div>
            <div class="action-grid" id="actionGrid">
                <!-- Analytics & Tracking -->
                <a href="/overview" class="action-card" data-category="analytics">
                    <div class="action-icon">📊</div>
                    <div class="action-title">Dashboard Overview</div>
                    <div class="action-description">Comprehensive analytics and insights</div>
                </a>

                <div class="action-card" onclick="viewHistory()" data-category="analytics">
                    <div class="action-icon">📋</div>
                    <div class="action-title">Transaction History</div>
                    <div class="action-description">View all your earnings and transactions</div>
                </div>

                <!-- Earning & Rewards -->
                <a href="/forum" class="action-card hot-card" data-category="social">
                    <div class="hot-badge">🔥 HOT</div>
                    <div class="action-icon">💬</div>
                    <div class="action-title">Community Forum</div>
                    <div class="action-description">Connect and discuss with the community</div>
                </a>

                <div class="action-card" onclick="openLearnEarn()" data-category="earning">
                    <div class="action-icon">📚</div>
                    <div class="action-title">Learn & Earn Quiz</div>
                    <div class="action-description">Take quizzes and earn up to 2000 G$ daily</div>
                </div>

                <div class="action-card" onclick="openReferralProgram()" data-category="earning">
                    <div class="action-icon">🔗</div>
                    <div class="action-title">Referral Rewards</div>
                    <div class="action-description">Invite friends and earn 100 G$ per referral</div>
                </div>

                <!-- Financial Services -->
                <div class="action-card" onclick="checkBalance()" data-category="financial">
                    <div class="action-icon">💳</div>
                    <div class="action-title">Check G$ Balance</div>
                    <div class="action-description">View your current GoodDollar balance</div>
                </div>

                <div class="action-card" onclick="sendTokens()" data-category="financial">
                    <div class="action-icon">📤</div>
                    <div class="action-title">Send GoodDollars</div>
                    <div class="action-description">Transfer G$ tokens to other wallets</div>
                </div>

                <a href="/reloadly" class="action-card" data-category="financial">
                    <div class="action-icon">📱</div>
                    <div class="action-title">GIMT Airtime Top-up</div>
                    <div class="action-description">Buy mobile credit with your G$ tokens</div>
                </a>

                <a href="/p2p-trading" class="action-card hot-card" data-category="financial">
                    <div class="hot-badge">🔥 NEW</div>
                    <div class="action-icon">🔄</div>
                    <div class="action-title">P2P Trading</div>
                    <div class="action-description">Trade G$ with other users safely</div>
                </a>

                <!-- Social & Community -->
                <a href="/news" class="action-card" data-category="social">
                    <div class="action-icon">📰</div>
                    <div class="action-title">Latest News</div>
                    <div class="action-description">Stay updated with GoodDollar announcements</div>
                </a>

                <div class="action-card" onclick="claimUBI()" data-category="earning">
                    <div class="action-icon">💰</div>
                    <div class="action-title">Claim UBI Rewards</div>
                    <div class="action-description">Claim your Universal Basic Income</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global error handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // Prevent the default browser behavior
            event.preventDefault();
        });

        let currentWallet = null;
        let bonusData = {};
        let learnEarnData = {}; // Added to store Learn & Earn eligibility data

        // Load hour bonus status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadHourBonusStatus();
            loadGoodDollarBalance();
            loadLearnEarnStatus(); // Call the function to load Learn & Earn status
            loadForumNotifications(); // Load forum notifications
            // Refresh status every 30 seconds
            setInterval(loadHourBonusStatus, 30000);
            setInterval(loadLearnEarnStatus, 30000); // Refresh Learn & Earn status
            setInterval(loadForumNotifications, 30000); // Refresh notifications
            // Refresh balance every 60 seconds
            setInterval(loadGoodDollarBalance, 60000);

            // Load P2P transaction history
            loadP2PHistory();
            // Load Reloadly transaction history
            loadReloadlyHistory();
        });

        // Function to load GoodDollar balance
        async function loadGoodDollarBalance() {
            try {
                const response = await fetch('/api/gooddollar-balance');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const rawText = await response.text();
                console.log('Balance API Raw Response:', rawText);

                if (!rawText || rawText.trim() === '') {
                    throw new Error('Empty response from server');
                }

                const data = JSON.parse(rawText);
                console.log('Balance API Parsed Data:', data);

                const balanceValue = document.getElementById('balanceValue');
                const balanceDescription = document.getElementById('balanceDescription');

                if (data && data.success && data.balance !== undefined) {
                    const balance = typeof data.balance === 'number' ? data.balance : parseFloat(data.balance) || 0;
                    balanceValue.textContent = `${balance.toFixed(2)} G$`;
                    balanceDescription.textContent = `Balance from ${data.contract.substring(0, 8)}...${data.contract.substring(data.contract.length - 6)}`;
                } else {
                    console.log('Balance API Error:', data);
                    balanceValue.textContent = 'Unavailable';
                    balanceDescription.textContent = data?.error || 'Service temporarily offline';
                }
            } catch (error) {
                console.error('Failed to load balance:', error);
                document.getElementById('balanceValue').textContent = 'Offline';
                document.getElementById('balanceDescription').textContent = 'Service unavailable';
            }
        }

        async function loadHourBonusStatus() {
            try {
                const response = await fetch('/api/hour-bonus/status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const rawText = await response.text();
                console.log('Hour Bonus API Raw Response:', rawText);

                if (!rawText || rawText.trim() === '') {
                    throw new Error('Empty response from server');
                }

                const data = JSON.parse(rawText);
                console.log('Hour Bonus API Parsed Data:', data);

                // Check if data exists and has valid content
                if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                    bonusData = data;
                    updateBonusUI(data);
                } else {
                    throw new Error('Invalid response structure');
                }
            } catch (error) {
                console.error('Failed to load bonus status:', error);
                document.getElementById('bonusStatus').textContent = 'Service unavailable';
                document.getElementById('claimBtn').disabled = true;
            }
        }

        function updateBonusUI(data) {
            const statusEl = document.getElementById('bonusStatus');
            const claimBtn = document.getElementById('claimBtn');

            if (data.can_claim_now) {
                statusEl.textContent = 'Ready to claim!';
                claimBtn.disabled = false;
                claimBtn.textContent = 'Claim 50 G$';
            } else {
                if (data.next_claim_time) {
                    const nextTime = new Date(data.next_claim_time);
                    const now = new Date();
                    const diff = nextTime - now;

                    if (diff > 0) {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        statusEl.textContent = `Next: ${hours}h ${minutes}m`;
                    } else {
                        statusEl.textContent = 'Ready soon...';
                    }
                }
                claimBtn.disabled = true;
                claimBtn.textContent = 'Wait 12h';
            }

            // Show total earned if available
            if (data.total_earned > 0) {
                statusEl.textContent += ` (Total: ${data.total_earned} G$)`;
            }
        }

        async function claimHourBonus() {
            const claimBtn = document.getElementById('claimBtn');
            const statusEl = document.getElementById('bonusStatus');

            claimBtn.disabled = true;
            claimBtn.textContent = 'Claiming...';
            statusEl.textContent = 'Processing...';

            try {
                const response = await fetch('/api/hour-bonus/claim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    statusEl.textContent = '✅ Claimed successfully!';
                    claimBtn.textContent = 'Claimed!';

                    // Show success message
                    alert(`🎉 Success! You received 50 G$!\n\nTransaction: ${result.transaction_hash}\n\nNext bonus available in 12 hours.`);

                    // Refresh status after 3 seconds
                    setTimeout(loadHourBonusStatus, 3000);
                } else {
                    statusEl.textContent = '❌ Claim failed';
                    claimBtn.textContent = 'Try Again';
                    claimBtn.disabled = false;

                    alert(`❌ Claim failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Claim error:', error);
                statusEl.textContent = '❌ Error occurred';
                claimBtn.textContent = 'Try Again';
                claimBtn.disabled = false;

                alert('❌ Network error. Please try again.');
            }
        }

        function claimUBI() {
            alert('🎯 UBI claiming feature coming soon! This will integrate with GoodDollar smart contracts.');
        }

        async function checkBalance() {
            try {
                const response = await fetch('/api/gooddollar-balance');
                const data = await response.json();

                if (data.success) {
                    alert(`💎 GoodDollar Balance\n\nBalance: ${data.balance_formatted}\n\nWallet: {{ wallet[:8] }}...{{ wallet[-6:] }}\nContract: ${data.contract.substring(0, 10)}...${data.contract.substring(data.contract.length - 8)}\n\n✅ Balance loaded from Celo blockchain`);
                } else {
                    alert(`❌ Failed to load balance: ${data.error}`);
                }
            } catch (error) {
                console.error('Balance check error:', error);
                alert('❌ Network error. Please try again.');
            }
        }

        function sendTokens() {
            alert('📤 Send tokens feature coming soon! This will enable G$ transfers.');
        }

        async function viewHistory() {
            // Create comprehensive transaction history modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f4c75 100%);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 80vh;
                    overflow-y: auto;
                    padding: 2rem;
                    color: white;
                    position: relative;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                ">
                    <div style="
                        position: sticky;
                        top: 0;
                        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f4c75 100%);
                        z-index: 1;
                        margin: -2rem -2rem 2rem -2rem;
                        padding: 2rem;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    ">
                        <button onclick="this.closest('.modal').remove()" style="
                            position: absolute;
                            top: 1rem;
                            right: 1rem;
                            background: rgba(255, 255, 255, 0.1);
                            border: none;
                            color: white;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            font-size: 1.2rem;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">×</button>

                        <h2 style="
                            margin: 0;
                            font-size: 1.8rem;
                            background: linear-gradient(45deg, #4facfe, #00f2fe);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            text-align: center;
                        ">📋 Transaction History</h2>

                    <div id="transactionTabs" style="
                        display: flex;
                        gap: 1rem;
                        margin-bottom: 2rem;
                        justify-content: center;
                    ">
                        <button onclick="showTransactionTab('hour-bonus')" class="tab-btn active" data-tab="hour-bonus" style="
                            background: linear-gradient(45deg, #4facfe, #00f2fe);
                            border: none;
                            color: white;
                            padding: 0.8rem 1.5rem;
                            border-radius: 12px;
                            cursor: pointer;
                            font-weight: 600;
                        ">🎁 Hour Bonus</button>
                        <button onclick="showTransactionTab('learn-earn')" class="tab-btn" data-tab="learn-earn" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            color: white;
                            padding: 0.8rem 1.5rem;
                            border-radius: 12px;
                            cursor: pointer;
                            font-weight: 600;
                        ">📚 Learn & Earn</button>
                        <button onclick="showTransactionTab('reloadly')" class="tab-btn" data-tab="reloadly" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            color: white;
                            padding: 0.8rem 1.5rem;
                            border-radius: 12px;
                            cursor: pointer;
                            font-weight: 600;
                        ">📱 Mobile Top-ups</button>
                        <button onclick="showTransactionTab('all')" class="tab-btn" data-tab="all" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            color: white;
                            padding: 0.8rem 1.5rem;
                            border-radius: 12px;
                            cursor: pointer;
                            font-weight: 600;
                        ">📊 All Transactions</button>
                        <button onclick="showTransactionTab('p2p')" class="tab-btn" data-tab="p2p" style="
                            background: rgba(255, 255, 255, 0.2);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            color: white;
                            padding: 0.8rem 1.5rem;
                            border-radius: 12px;
                            cursor: pointer;
                            font-weight: 600;
                        ">🔄 P2P Trades</button>
                    </div>
                    </div>

                    <div id="transactionContent" style="
                        min-height: 200px;
                    ">
                        Loading transaction history...
                    </div>
                </div>
            `;

            modal.classList.add('modal');
            document.body.appendChild(modal);

            // Load hour bonus history by default
            loadHourBonusHistoryInModal();

        }

        // Fix for missing loadHourBonusHistory function
        function loadHourBonusHistory() {
            return loadHourBonusHistoryInModal();
        }

        async function loadHourBonusHistoryInModal() {
            try {
                const response = await fetch('/api/hour-bonus/history?limit=20');
                const data = await response.json();
                displayHourBonusInModal(data.history || []);
            } catch (error) {
                console.error('Failed to load hour bonus history:', error);
                document.getElementById('transactionContent').innerHTML = 
                    '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">❌ Failed to load transaction history</div>';
            }
        }

        function displayHourBonusInModal(history) {
            const content = document.getElementById('transactionContent');

            if (!history || history.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">🎁</div>
                        <div>No hour bonus claims yet</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                            Claim your first 12-hour bonus to see history here!
                        </div>
                    </div>
                `;
                return;
            }

            const historyHTML = history.map(item => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString();

                return `
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                       onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: #4ade80;">
                                +${item.bonus_amount} G$
                            </div>
                            <div style="
                                padding: 0.3rem 0.8rem;
                                border-radius: 20px;
                                font-size: 0.8rem;
                                font-weight: 600;
                                background: rgba(74, 222, 128, 0.2);
                                color: #4ade80;
                                border: 1px solid rgba(74, 222, 128, 0.3);
                            ">✅ Success</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Date</div>
                                <div style="color: white; font-weight: 500;">${formattedDate}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Time</div>
                                <div style="color: white; font-weight: 500;">${formattedTime}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Type</div>
                                <div style="color: white; font-weight: 500;">${item.bonus_type || '12-hour'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                <div style="
                                    font-family: monospace;
                                    font-size: 0.8rem;
                                    cursor: pointer;
                                    color: #60a5fa;
                                    text-decoration: underline;
                                    word-break: break-all;
                                " onclick="window.open('https://explorer.celo.org/mainnet/tx/${item.transaction_hash}', '_blank')">
                                    ${item.transaction_hash.substring(0, 10)}...${item.transaction_hash.substring(item.transaction_hash.length - 8)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = historyHTML;
        }

        async function showTransactionTab(tabType) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabType) {
                    btn.style.background = 'linear-gradient(45deg, #4facfe, #00f2fe)';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'rgba(255, 255, 255, 0.2)';
                    btn.style.border = '1px solid rgba(255, 255, 255, 0.3)';
                    btn.classList.remove('active');
                }
            });

            // Load appropriate content
            if (tabType === 'hour-bonus') {
                loadHourBonusHistoryInModal();
            } else if (tabType === 'learn-earn') {
                loadLearnEarnHistory();
            } else if (tabType === 'reloadly') {
                loadReloadlyHistory();
            } else if (tabType === 'all') {
                loadAllTransactions();
            } else if (tabType === 'p2p') {
                loadP2PHistory();
            }
        }

        async function loadLearnEarnHistory() {
            try {
                const content = document.getElementById('transactionContent');
                content.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">Loading Learn & Earn history...</div>';

                const response = await fetch('/learn-earn/quiz-history?limit=50');
                const data = await response.json();

                console.log('Learn & Earn API Response:', data);
                console.log('Quiz History Data:', data.quiz_history);

                displayLearnEarnHistory(data.quiz_history || []);
            } catch (error) {
                console.error('Learn & Earn history error:', error);
                document.getElementById('transactionContent').innerHTML = 
                    '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">❌ Failed to load Learn & Earn history</div>';
            }
        }

        function displayLearnEarnHistory(history) {
            const content = document.getElementById('transactionContent');

            if (!history || history.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📚</div>
                        <div>No Learn & Earn history yet</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                            Take quizzes to start earning G$ rewards!
                        </div>
                    </div>
                `;
                return;
            }

            const historyHTML = history.map(item => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Improved transaction hash handling
                const hasValidTxHash = item.transaction_hash && 
                                     item.transaction_hash !== 'null' && 
                                     item.transaction_hash !== null && 
                                     item.transaction_hash.trim() !== '' && 
                                     item.transaction_hash.length > 10;

                const transactionHashDisplay = hasValidTxHash ? 
                    `<div style="
                        font-family: monospace;
                        font-size: 0.8rem;
                        cursor: pointer;
                        color: #60a5fa;
                        text-decoration: underline;
                        word-break: break-all;
                    " onclick="window.open('https://explorer.celo.org/mainnet/tx/${item.transaction_hash}', '_blank')" 
                       title="Click to view on Celo Explorer: ${item.transaction_hash}">
                        ${item.transaction_hash.substring(0, 10)}...${item.transaction_hash.substring(item.transaction_hash.length - 8)}
                    </div>` : 
                    `<div style="
                        font-size: 0.8rem;
                        color: rgba(255, 255, 255, 0.5);
                        font-style: italic;
                    " title="No transaction hash available">Pending/No Hash</div>`;

                return `
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                       onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <div style="font-size: 1.5rem;">📚</div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #10b981;">
                                        +${item.amount_g$ || 0} G$
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        Learn & Earn Quiz
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem;">
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                    ${formattedDate} ${formattedTime}
                                </div>
                                <div style="
                                    padding: 0.3rem 0.8rem;
                                    border-radius: 20px;
                                    font-size: 0.8rem;
                                    font-weight: 600;
                                    background: ${hasValidTxHash ? 'rgba(74, 222, 128, 0.2)' : 'rgba(251, 191, 36, 0.2)'};
                                    color: ${hasValidTxHash ? '#4ade80' : '#fbbf24'};
                                    border: 1px solid ${hasValidTxHash ? 'rgba(74, 222, 128, 0.3)' : 'rgba(251, 191, 36, 0.3)'};
                                ">${hasValidTxHash ? '✅ Confirmed' : '⏳ Processing'}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Date</div>
                                <div style="color: white; font-weight: 500;">${formattedDate}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Time</div>
                                <div style="color: white; font-weight: 500;">${formattedTime}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Score</div>
                                <div style="color: white; font-weight: 500;">${item.score}/${item.total_questions} (${Math.round((item.score / item.total_questions) * 100)}%)</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                ${transactionHashDisplay}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = historyHTML;
        }

        async function loadReloadlyHistory() {
            try {
                const response = await fetch('/api/reloadly/history?limit=50');
                const data = await response.json();

                console.log('Reloadly History Response:', data);

                displayReloadlyHistory(data.history || []);
            } catch (error) {
                console.error('Reloadly history error:', error);
                document.getElementById('transactionContent').innerHTML = 
                    '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">❌ Failed to load mobile top-up history</div>';
            }
        }

        function displayReloadlyHistory(history) {
            const content = document.getElementById('transactionContent');

            if (!history || history.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📱</div>
                        <div>No mobile top-up history yet</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                            Purchase mobile credit to see your transaction history!
                        </div>
                    </div>
                `;
                return;
            }

            const historyHTML = history.map(item => {
                const date = new Date(item.created_at);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Status color based on order status
                const statusColors = {
                    'completed': { bg: 'rgba(74, 222, 128, 0.2)', color: '#4ade80', text: '✅ Completed' },
                    'pending_payment': { bg: 'rgba(251, 191, 36, 0.2)', color: '#fbbf24', text: '⏳ Pending Payment' },
                    'payment_confirmed': { bg: 'rgba(59, 130, 246, 0.2)', color: '#3b82f6', text: '💰 Payment Confirmed' },
                    'processing': { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7', text: '🔄 Processing' },
                    'failed': { bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444', text: '❌ Failed' },
                    'refunded': { bg: 'rgba(156, 163, 175, 0.2)', color: '#9ca3af', text: '🔄 Refunded' }
                };

                const statusInfo = statusColors[item.status] || statusColors['pending_payment'];

                return `
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                       onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <div style="font-size: 1.5rem;">📱</div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #60a5fa;">
                                        ${item.g_dollar_amount || item.amount} G$
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        Mobile Top-up
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem;">
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                    ${formattedDate} ${formattedTime}
                                </div>
                                <div style="
                                    padding: 0.3rem 0.8rem;
                                    border-radius: 20px;
                                    font-size: 0.8rem;
                                    font-weight: 600;
                                    background: ${statusInfo.bg};
                                    color: ${statusInfo.color};
                                    border: 1px solid ${statusInfo.color}30;
                                ">${statusInfo.text}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Phone Number</div>
                                <div style="color: white; font-weight: 500;">${item.phone_number}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Amount</div>
                                <div style="color: white; font-weight: 500;">${item.local_amount} ${item.local_currency}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Order ID</div>
                                <div style="color: white; font-weight: 500; font-family: monospace; font-size: 0.8rem;">${item.order_id}</div>
                            </div>
                            ${item.transaction_hash ? `
                                <div>
                                    <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                    <div style="
                                        font-family: monospace;
                                        font-size: 0.8rem;
                                        cursor: pointer;
                                        color: #60a5fa;
                                        text-decoration: underline;
                                        word-break: break-all;
                                    " onclick="window.open('https://explorer.celo.org/mainnet/tx/${item.transaction_hash}', '_blank')" 
                                       title="Click to view on Celo Explorer: ${item.transaction_hash}">
                                        ${item.transaction_hash.substring(0, 10)}...${item.transaction_hash.substring(item.transaction_hash.length - 8)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = historyHTML;
        }

        async function loadAllTransactions() {
            try {
                const content = document.getElementById('transactionContent');
                content.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">Loading all transactions...</div>';

                // Load hour bonus, learn & earn, reloadly, and P2P data
                const [hourBonusResponse, learnEarnResponse, reloadlyResponse, p2pResponse] = await Promise.all([
                    fetch('/api/hour-bonus/history?limit=50'),
                    fetch('/learn-earn/quiz-history?limit=50'),
                    fetch('/api/reloadly/history?limit=50'),
                    fetch('/api/p2p/history?limit=50')
                ]);

                const hourBonusData = await hourBonusResponse.json();
                const learnEarnData = await learnEarnResponse.json();
                const reloadlyData = await reloadlyResponse.json();
                const p2pData = await p2pResponse.json();

                // Combine and sort all transactions by timestamp
                const allTransactions = [];

                // Add hour bonus transactions
                if (hourBonusData.history) {
                    hourBonusData.history.forEach(item => {
                        allTransactions.push({
                            type: 'hour-bonus',
                            timestamp: item.timestamp,
                            amount: item.bonus_amount,
                            transaction_hash: item.transaction_hash,
                            details: item
                        });
                    });
                }

                // Add learn & earn transactions
                if (learnEarnData.success && learnEarnData.quiz_history) {
                    learnEarnData.quiz_history.forEach(item => {
                        allTransactions.push({
                            type: 'learn-earn',
                            timestamp: item.timestamp,
                            amount: item.amount_g$ || 0,
                            transaction_hash: item.transaction_hash,
                            details: item
                        });
                    });
                }

                // Add reloadly transactions
                if (reloadlyData.history) {
                    reloadlyData.history.forEach(item => {
                        allTransactions.push({
                            type: 'reloadly',
                            timestamp: item.created_at,
                            amount: item.g_dollar_amount || item.amount,
                            transaction_hash: item.transaction_hash,
                            details: item
                        });
                    });
                }

                // Add P2P transactions
                if (p2pData.trades) {
                    p2pData.trades.forEach(trade => {
                        const date = new Date(trade.completed_at || trade.created_at);
                        const userWallet = '{{ wallet }}';
                        const userRole = trade.seller_wallet && trade.seller_wallet.toLowerCase() === userWallet.toLowerCase() ? 'Seller' : 'Buyer';
                        let displayTxHash = trade.release_tx_hash || trade.seller_deposit_tx || '';
                        if (displayTxHash && !displayTxHash.startsWith('0x')) {
                            displayTxHash = '0x' + displayTxHash;
                        }
                        allTransactions.push({
                            type: 'p2p',
                            timestamp: date.toISOString(),
                            amount: trade.g_dollar_amount,
                            transaction_hash: displayTxHash,
                            details: trade
                        });
                    });
                }

                // Sort by timestamp (newest first)
                allTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (allTransactions.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📊</div>
                            <div>No transactions yet</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                                Start claiming bonuses, taking quizzes, or trading to see your transaction history!
                            </div>
                        </div>
                    `;
                    return;
                }

                const transactionsHTML = allTransactions.map(tx => {
                    const date = new Date(tx.timestamp);
                    let typeIcon, typeColor, typeName;

                    switch (tx.type) {
                        case 'hour-bonus':
                            typeIcon = '🎁'; typeColor = '#4ade80'; typeName = '12-Hour Bonus';
                            break;
                        case 'learn-earn':
                            typeIcon = '📚'; typeColor = '#fbbf24'; typeName = 'Learn & Earn Quiz';
                            break;
                        case 'reloadly':
                            typeIcon = '📱'; typeColor = '#60a5fa'; typeName = 'Mobile Top-up';
                            break;
                        case 'p2p':
                            typeIcon = '🔄'; typeColor = '#8b5cf6'; typeName = 'P2P Trade';
                            break;
                        default:
                            typeIcon = '❓'; typeColor = '#9ca3af'; typeName = 'Other';
                    }

                    // Check if transaction hash is valid
                    const hasValidTxHash = tx.transaction_hash && 
                                         tx.transaction_hash !== 'null' && 
                                         tx.transaction_hash !== null && 
                                         tx.transaction_hash.trim() !== '' && 
                                         tx.transaction_hash.length > 10;

                    let extraDetails = '';
                    if (tx.type === 'learn-earn') {
                        const percentage = Math.round((tx.details.score / tx.details.total_questions) * 100);
                        extraDetails = `
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Quiz Score</div>
                                <div>${tx.details.score}/${tx.details.total_questions} (${percentage}%)</div>
                            </div>
                        `;
                    } else if (tx.type === 'reloadly') {
                        extraDetails = `
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Phone Number</div>
                                <div>${tx.details.phone_number}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Status</div>
                                <div>${tx.details.status}</div>
                            </div>
                        `;
                    } else if (tx.type === 'p2p') {
                        const userWallet = '{{ wallet }}';
                        const userRole = tx.details.seller_wallet && tx.details.seller_wallet.toLowerCase() === userWallet.toLowerCase() ? 'Seller' : 'Buyer';
                        extraDetails = `
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Trade ID</div>
                                <div>${tx.details.trade_id}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Role</div>
                                <div>${userRole}</div>
                            </div>
                        `;
                    }

                    return `
                        <div style="
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 12px;
                            padding: 1.5rem;
                            margin-bottom: 1rem;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                           onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                                <div style="display: flex; align-items: center; gap: 0.8rem;">
                                    <div style="font-size: 1.5rem;">${typeIcon}</div>
                                    <div>
                                        <div style="font-size: 1.3rem; font-weight: 700; color: ${typeColor};">
                                            +${tx.amount} G$
                                        </div>
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                            ${typeName}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem;">
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        ${date.toLocaleDateString()} ${date.toLocaleTimeString()}
                                    </div>
                                    <div style="
                                        padding: 0.2rem 0.6rem;
                                        border-radius: 15px;
                                        font-size: 0.7rem;
                                        font-weight: 600;
                                        background: ${hasValidTxHash ? 'rgba(74, 222, 128, 0.2)' : 'rgba(251, 191, 36, 0.2)'};
                                        color: ${hasValidTxHash ? '#4ade80' : '#fbbf24'};
                                        border: 1px solid ${hasValidTxHash ? 'rgba(74, 222, 128, 0.3)' : 'rgba(251, 191, 36, 0.3)'};
                                    ">${hasValidTxHash ? '✅ Confirmed' : '⏳ Processing'}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                                ${extraDetails}
                                <div>
                                    <div style="color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                    ${hasValidTxHash ? `
                                        <div style="
                                            font-family: monospace; 
                                            font-size: 0.8rem; 
                                            cursor: pointer; 
                                            color: #60a5fa;
                                            text-decoration: underline;
                                            word-break: break-all;
                                        " onclick="window.open('https://explorer.celo.org/mainnet/tx/${tx.transaction_hash}', '_blank')">
                                            ${tx.transaction_hash.substring(0, 8)}...${tx.transaction_hash.substring(tx.transaction_hash.length - 6)}
                                        </div>
                                    ` : `
                                        <div style="
                                            font-size: 0.8rem;
                                            color: rgba(255, 255, 255, 0.5);
                                            font-style: italic;
                                        ">Pending/No Hash</div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = transactionsHTML;

            } catch (error) {
                console.error('All transactions error:', error);
                document.getElementById('transactionContent').innerHTML = 
                    '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">❌ Failed to load transaction history</div>';
            }
        }

        function displayP2PHistory(history) {
            const content = document.getElementById('transactionContent');

            if (!history || history.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">🔄</div>
                        <div>No P2P trading history yet</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                            Start trading on the P2P platform to see your transaction history!
                        </div>
                    </div>
                `;
                return;
            }

            const historyHTML = history.map(trade => {
                const date = new Date(trade.completed_at || trade.created_at);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Determine user's role in the trade
                const userWallet = '{{ wallet }}';
                const userRole = trade.seller_wallet && trade.seller_wallet.toLowerCase() === userWallet.toLowerCase() ? 'Seller' : 'Buyer';
                const counterpartyWallet = userRole === 'Seller' ? trade.buyer_wallet : trade.seller_wallet;

                // Status color based on trade status
                const statusColors = {
                    'completed': { bg: 'rgba(74, 222, 128, 0.2)', color: '#4ade80', text: '✅ Completed' },
                    'waiting_seller_deposit': { bg: 'rgba(251, 191, 36, 0.2)', color: '#fbbf24', text: '⏳ Waiting Deposit' },
                    'escrow_active': { bg: 'rgba(59, 130, 246, 0.2)', color: '#3b82f6', text: '🔒 Escrow Active' },
                    'payment_sent': { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7', text: '💰 Payment Sent' },
                    'cancelled': { bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444', text: '❌ Cancelled' }
                };

                const statusInfo = statusColors[trade.status] || statusColors['waiting_seller_deposit'];

                // Ensure transaction hash has 0x prefix
                let displayTxHash = trade.release_tx_hash || trade.seller_deposit_tx || '';
                if (displayTxHash && !displayTxHash.startsWith('0x')) {
                    displayTxHash = '0x' + displayTxHash;
                }

                const hasValidTxHash = displayTxHash && displayTxHash.length > 10;

                return `
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                       onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <div style="font-size: 1.5rem;">🔄</div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #8b5cf6;">
                                        ${trade.g_dollar_amount} G$
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        P2P Trading (${userRole})
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem;">
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                    ${formattedDate} ${formattedTime}
                                </div>
                                <div style="
                                    padding: 0.3rem 0.8rem;
                                    border-radius: 20px;
                                    font-size: 0.8rem;
                                    font-weight: 600;
                                    background: ${statusInfo.bg};
                                    color: ${statusInfo.color};
                                    border: 1px solid ${statusInfo.color}30;
                                ">${statusInfo.text}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Trade ID</div>
                                <div style="font-family: monospace; font-size: 0.8rem;">${trade.trade_id}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Fiat Amount</div>
                                <div>${trade.fiat_amount} ${trade.fiat_currency}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Payment Method</div>
                                <div>${trade.payment_method}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Counterparty</div>
                                <div style="font-family: monospace; font-size: 0.8rem;">${counterpartyWallet.substring(0, 8)}...${counterpartyWallet.substring(counterpartyWallet.length - 6)}</div>
                            </div>
                            ${hasValidTxHash ? `
                                <div>
                                    <div style="color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                    <div style="
                                        font-family: monospace;
                                        font-size: 0.8rem;
                                        cursor: pointer;
                                        color: #60a5fa;
                                        text-decoration: underline;
                                        word-break: break-all;
                                    " onclick="window.open('https://explorer.celo.org/mainnet/tx/${displayTxHash}', '_blank')" 
                                       title="Click to view on Celo Explorer: ${displayTxHash}">
                                        ${displayTxHash.substring(0, 10)}...${displayTxHash.substring(displayTxHash.length - 8)}
                                    </div>
                                </div>
                            ` : `
                                <div>
                                    <div style="color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                    <div style="
                                        font-size: 0.8rem;
                                        color: rgba(255, 255, 255, 0.5);
                                        font-style: italic;
                                    ">No transaction hash</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = historyHTML;
        }

        async function loadP2PHistory() {
            try {
                const response = await fetch('/api/p2p/history?limit=50');
                const data = await response.json();

                console.log('P2P History Response:', data);
                displayP2PHistory(data.trades || []);
            } catch (error) {
                console.error('P2P history error:', error);
                document.getElementById('transactionContent').innerHTML = 
                    '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">❌ Failed to load P2P history</div>';
            }
        }

        async function loadAllTransactions() {
            try {
                const content = document.getElementById('transactionContent');
                content.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">Loading all transactions...</div>';

                // Load hour bonus, learn & earn, reloadly, and P2P data
                const [hourBonusResponse, learnEarnResponse, reloadlyResponse, p2pResponse] = await Promise.all([
                    fetch('/api/hour-bonus/history?limit=50'),
                    fetch('/learn-earn/quiz-history?limit=50'),
                    fetch('/api/reloadly/history?limit=50'),
                    fetch('/api/p2p/history?limit=50')
                ]);

                const hourBonusData = await hourBonusResponse.json();
                const learnEarnData = await learnEarnResponse.json();
                const reloadlyData = await reloadlyResponse.json();
                const p2pData = await p2pResponse.json();

                // Combine and sort all transactions by timestamp
                const allTransactions = [];

                // Add hour bonus transactions
                if (hourBonusData.history) {
                    hourBonusData.history.forEach(item => {
                        allTransactions.push({
                            type: 'hour-bonus',
                            timestamp: item.timestamp,
                            amount: item.bonus_amount,
                            transaction_hash: item.transaction_hash,
                            details: item
                        });
                    });
                }

                // Add learn & earn transactions
                if (learnEarnData.success && learnEarnData.quiz_history) {
                    learnEarnData.quiz_history.forEach(item => {
                        allTransactions.push({
                            type: 'learn-earn',
                            timestamp: item.timestamp,
                            amount: item.amount_g$ || 0,
                            transaction_hash: item.transaction_hash,
                            details: item
                        });
                    });
                }

                // Add reloadly transactions
                if (reloadlyData.history) {
                    reloadlyData.history.forEach(item => {
                        allTransactions.push({
                            type: 'reloadly',
                            timestamp: item.created_at,
                            amount: item.g_dollar_amount || item.amount,
                            transaction_hash: item.transaction_hash,
                            details: item
                        });
                    });
                }

                // Add P2P transactions
                if (p2pData.trades) {
                    p2pData.trades.forEach(trade => {
                        const date = new Date(trade.completed_at || trade.created_at);
                        const userWallet = '{{ wallet }}';
                        const userRole = trade.seller_wallet && trade.seller_wallet.toLowerCase() === userWallet.toLowerCase() ? 'Seller' : 'Buyer';
                        let displayTxHash = trade.release_tx_hash || trade.seller_deposit_tx || '';
                        if (displayTxHash && !displayTxHash.startsWith('0x')) {
                            displayTxHash = '0x' + displayTxHash;
                        }
                        allTransactions.push({
                            type: 'p2p',
                            timestamp: date.toISOString(),
                            amount: trade.g_dollar_amount,
                            transaction_hash: displayTxHash,
                            details: trade
                        });
                    });
                }

                // Sort by timestamp (newest first)
                allTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (allTransactions.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📊</div>
                            <div>No transactions yet</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                                Start claiming bonuses, taking quizzes, or trading to see your transaction history!
                            </div>
                        </div>
                    `;
                    return;
                }

                const transactionsHTML = allTransactions.map(tx => {
                    const date = new Date(tx.timestamp);
                    let typeIcon, typeColor, typeName;

                    switch (tx.type) {
                        case 'hour-bonus':
                            typeIcon = '🎁'; typeColor = '#4ade80'; typeName = '12-Hour Bonus';
                            break;
                        case 'learn-earn':
                            typeIcon = '📚'; typeColor = '#fbbf24'; typeName = 'Learn & Earn Quiz';
                            break;
                        case 'reloadly':
                            typeIcon = '📱'; typeColor = '#60a5fa'; typeName = 'Mobile Top-up';
                            break;
                        case 'p2p':
                            typeIcon = '🔄'; typeColor = '#8b5cf6'; typeName = 'P2P Trade';
                            break;
                        default:
                            typeIcon = '❓'; typeColor = '#9ca3af'; typeName = 'Other';
                    }

                    // Check if transaction hash is valid
                    const hasValidTxHash = tx.transaction_hash && 
                                         tx.transaction_hash !== 'null' && 
                                         tx.transaction_hash !== null && 
                                         tx.transaction_hash.trim() !== '' && 
                                         tx.transaction_hash.length > 10;

                    let extraDetails = '';
                    if (tx.type === 'learn-earn') {
                        const percentage = Math.round((tx.details.score / tx.details.total_questions) * 100);
                        extraDetails = `
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Quiz Score</div>
                                <div>${tx.details.score}/${tx.details.total_questions} (${percentage}%)</div>
                            </div>
                        `;
                    } else if (tx.type === 'reloadly') {
                        extraDetails = `
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Phone Number</div>
                                <div>${tx.details.phone_number}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Status</div>
                                <div>${tx.details.status}</div>
                            </div>
                        `;
                    } else if (tx.type === 'p2p') {
                        const userWallet = '{{ wallet }}';
                        const userRole = tx.details.seller_wallet && tx.details.seller_wallet.toLowerCase() === userWallet.toLowerCase() ? 'Seller' : 'Buyer';
                        extraDetails = `
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Trade ID</div>
                                <div>${tx.details.trade_id}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Role</div>
                                <div>${userRole}</div>
                            </div>
                        `;
                    }

                    return `
                        <div style="
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 12px;
                            padding: 1.5rem;
                            margin-bottom: 1rem;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                           onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                                <div style="display: flex; align-items: center; gap: 0.8rem;">
                                    <div style="font-size: 1.5rem;">${typeIcon}</div>
                                    <div>
                                        <div style="font-size: 1.3rem; font-weight: 700; color: ${typeColor};">
                                            +${tx.amount} G$
                                        </div>
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                            ${typeName}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem;">
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        ${date.toLocaleDateString()} ${date.toLocaleTimeString()}
                                    </div>
                                    <div style="
                                        padding: 0.2rem 0.6rem;
                                        border-radius: 15px;
                                        font-size: 0.7rem;
                                        font-weight: 600;
                                        background: ${hasValidTxHash ? 'rgba(74, 222, 128, 0.2)' : 'rgba(251, 191, 36, 0.2)'};
                                        color: ${hasValidTxHash ? '#4ade80' : '#fbbf24'};
                                        border: 1px solid ${hasValidTxHash ? 'rgba(74, 222, 128, 0.3)' : 'rgba(251, 191, 36, 0.3)'};
                                    ">${hasValidTxHash ? '✅ Confirmed' : '⏳ Processing'}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                                ${extraDetails}
                                <div>
                                    <div style="color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                    ${hasValidTxHash ? `
                                        <div style="
                                            font-family: monospace; 
                                            font-size: 0.8rem; 
                                            cursor: pointer; 
                                            color: #60a5fa;
                                            text-decoration: underline;
                                            word-break: break-all;
                                        " onclick="window.open('https://explorer.celo.org/mainnet/tx/${tx.transaction_hash}', '_blank')">
                                            ${tx.transaction_hash.substring(0, 8)}...${tx.transaction_hash.substring(tx.transaction_hash.length - 6)}
                                        </div>
                                    ` : `
                                        <div style="
                                            font-size: 0.8rem;
                                            color: rgba(255, 255, 255, 0.5);
                                            font-style: italic;
                                        ">Pending/No Hash</div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = transactionsHTML;

            } catch (error) {
                console.error('All transactions error:', error);
                document.getElementById('transactionContent').innerHTML = 
                    '<div style="text-align: center; color: rgba(255, 255, 255, 0.7);">❌ Failed to load transaction history</div>';
            }
        }

        // Learn & Earn status and countdown timer - FIXED 24-hour sync with Supabase
        async function loadLearnEarnStatus() {
            try {
                const response = await fetch('/learn-earn/eligibility');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const rawText = await response.text();
                console.log('Learn & Earn Eligibility Raw Response:', rawText);

                if (!rawText || rawText.trim() === '') {
                    throw new Error('Empty response from server');
                }

                const data = JSON.parse(rawText);
                console.log('Learn & Earn Eligibility Parsed Data:', data);

                // Check if data exists and has valid content
                if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                    learnEarnData = data; // Store data for use in countdown
                    updateLearnEarnUI(data);
                } else {
                    throw new Error('Invalid response structure');
                }
            } catch (error) {
                console.error('Failed to load Learn & Earn status:', error);
                const statusEl = document.getElementById('learnEarnStatus');
                const btnEl = document.getElementById('learnEarnBtn');
                const sectionEl = document.getElementById('learnEarnSection');

                if (statusEl) statusEl.textContent = 'Service unavailable';
                if (btnEl) btnEl.disabled = true;
                if (sectionEl) sectionEl.style.display = 'none';
            }
        }

        function updateLearnEarnUI(data) {
            const sectionEl = document.getElementById('learnEarnSection');
            const statusEl = document.getElementById('learnEarnStatus');
            const btnEl = document.getElementById('learnEarnBtn');

            if (!sectionEl || !statusEl || !btnEl) {
                console.error('Learn & Earn UI elements not found');
                return;
            }

            if (data.success && data.eligible) {
                // User is eligible, show the quiz start interface
                sectionEl.style.display = 'flex';
                statusEl.textContent = 'Quiz Available!';
                btnEl.disabled = false;
                btnEl.textContent = 'Take Quiz';

                // Clear any existing countdown
                if (learnEarnCountdownInterval) {
                    clearInterval(learnEarnCountdownInterval);
                    learnEarnCountdownInterval = null;
                }
            } else if (data.blocked && data.next_quiz_time) {
                // Show countdown timer for 24-hour cooldown - SYNCED WITH SUPABASE
                sectionEl.style.display = 'flex';
                btnEl.disabled = true;
                btnEl.textContent = 'Wait 24h';

                // Start countdown timer using Supabase timestamp
                startLearnEarnCountdownFromSupabase(data.next_quiz_time);
            } else {
                // Hide section if not available
                sectionEl.style.display = 'none';

                // Clear any existing countdown
                if (learnEarnCountdownInterval) {
                    clearInterval(learnEarnCountdownInterval);
                    learnEarnCountdownInterval = null;
                }
            }
        }

        let learnEarnCountdownInterval = null;

        function startLearnEarnCountdownFromSupabase(nextQuizTimeStr) {
            // Clear any existing interval
            if (learnEarnCountdownInterval) {
                clearInterval(learnEarnCountdownInterval);
                learnEarnCountdownInterval = null;
            }

            const statusEl = document.getElementById('learnEarnStatus');
            if (!statusEl) {
                console.error('Learn & Earn status element not found');
                return;
            }

            // FIXED: Parse backend UTC timestamp correctly without timezone conversion
            let nextQuizTime;
            try {
                // Backend sends naive UTC timestamps from Supabase like "2025-09-06T16:40:53"
                // We need to parse this as UTC time, not local time
                if (nextQuizTimeStr.endsWith('Z')) {
                    // Already has UTC indicator - parse directly
                    nextQuizTime = new Date(nextQuizTimeStr).getTime();
                } else if (nextQuizTimeStr.includes('+') || nextQuizTimeStr.includes('T') && nextQuizTimeStr.match(/[+-]\d{2}:\d{2}$/)) {
                    // Has explicit timezone offset - parse with timezone
                    nextQuizTime = new Date(nextQuizTimeStr).getTime();
                } else {
                    // Naive datetime from Supabase - treat as UTC by adding Z suffix
                    // This prevents the browser from interpreting it as local time
                    nextQuizTime = new Date(nextQuizTimeStr + 'Z').getTime();
                }

                // Validate the parsed timestamp
                if (isNaN(nextQuizTime) || nextQuizTime <= 0) {
                    throw new Error('Invalid timestamp parsing result');
                }

            } catch (parseError) {
                console.error('❌ Error parsing Learn & Earn next quiz time from Supabase:', parseError);
                console.error('Original timestamp from backend:', nextQuizTimeStr);
                statusEl.textContent = 'Error calculating countdown';
                return;
            }

            // Debug logging to verify exact 24-hour sync with backend
            console.log('=== Learn & Earn 24-Hour Countdown FIXED ===');
            console.log('Backend next_quiz_time from Supabase:', nextQuizTimeStr);
            console.log('Parsed nextQuizTime (UTC):', new Date(nextQuizTime).toISOString());
            console.log('Current time (UTC):', new Date().toISOString());
            console.log('Time remaining (ms):', Math.max(0, nextQuizTime - Date.now()));
            console.log('Total hours remaining (24-hour cooldown):', Math.floor(Math.max(0, nextQuizTime - Date.now()) / (1000 * 60 * 60)));
            console.log('=== End Debug ===');

            const updateSupabaseCountdown = () => {
                const now = Date.now();
                const currentRemaining = Math.max(0, nextQuizTime - now);

                // Calculate exact hours, minutes, and seconds for 24-hour countdown
                const totalHours = Math.floor(currentRemaining / (1000 * 60 * 60));
                const minutes = Math.floor((currentRemaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((currentRemaining % (1000 * 60)) / 1000);

                if (currentRemaining <= 0) {
                    // Countdown finished - quiz available
                    statusEl.textContent = 'Quiz Available!';
                    const btnEl = document.getElementById('learnEarnBtn');
                    if (btnEl) {
                        btnEl.disabled = false;
                        btnEl.textContent = 'Take Quiz';
                    }

                    clearInterval(learnEarnCountdownInterval);
                    learnEarnCountdownInterval = null;

                    // Refresh Learn & Earn status after countdown ends
                    setTimeout(loadLearnEarnStatus, 2000);
                } else {
                    // Display countdown with proper 24-hour formatting
                    if (totalHours >= 1) {
                        statusEl.textContent = `Next: ${totalHours}h ${minutes}m`;
                    } else if (minutes >= 1) {
                        statusEl.textContent = `Next: ${minutes}m ${seconds}s`;
                    } else {
                        statusEl.textContent = `Next: ${seconds}s`;
                    }
                }
            };

            // Start the countdown immediately and update every second
            updateSupabaseCountdown(); // Initial call
            learnEarnCountdownInterval = setInterval(updateSupabaseCountdown, 1000);
        }

        // Legacy function for backward compatibility
        function startLearnEarnCountdown(nextQuizTimeStr) {
            // Redirect to the new Supabase-synced function
            startLearnEarnCountdownFromSupabase(nextQuizTimeStr);
        }

        // Function to handle the Learn & Earn eligibility check and display appropriate messages
        async function checkLearnEarnEligibility() {
            try {
                const response = await fetch('/learn-earn/eligibility');
                const eligibilityData = await response.json();
                learnEarnData = eligibilityData; // Update learnEarnData

                const content = document.getElementById('learnEarnContent');

                if (eligibilityData.success && eligibilityData.eligible) {
                    // User is eligible, show the quiz start interface
                    content.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">🎯</div>
                            <p>Ready to test your knowledge and earn G$ rewards?</p>
                            <div style="margin: 1.5rem 0;">
                                <strong>Quiz Details:</strong><br>
                                • 10 questions about GoodDollar<br>
                                • 200 G$ per correct answer<br>
                                • Maximum reward: 2000 G$<br>
                                • 24-hour cooldown between quizzes
                            </div>
                            <button onclick="startLearnEarnQuiz()" style="
                                background: linear-gradient(45deg, #4facfe, #00f2fe);
                                border: none;
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 1rem;
                            ">Start Quiz</button>
                            <button onclick="showLearnEarnHistory()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 1rem;
                            ">View History</button>
                        </div>
                    `;
                } else if (eligibilityData.blocked) {
                    // User is blocked due to cooldown, show the cooldown message
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">⏰</div>
                            <h3 style="color: #fbbf24; margin-bottom: 1rem;">24-Hour Quiz Cooldown Active</h3>
                            <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                                You have completed a quiz recently. Please wait 24 hours before taking another quiz.
                            </p>
                            <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">⏱️ Cooldown Period: 24 Hours</div>
                                <div id="learnEarnCountdown">Calculating...</div>
                            </div>
                            <button onclick="showLearnEarnHistory()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 0.95rem;
                            ">View Quiz History</button>
                        </div>
                    `;

                    // Start the countdown timer for the cooldown
                    if (eligibilityData.next_quiz_time) {
                        const nextQuizTimeStr = eligibilityData.next_quiz_time;
                        let nextQuizTime;

                        // Parse the datetime string correctly - UTC TIMEZONE FIXED
                        try {
                            // Backend sends UTC timestamps with 'Z' suffix - parse as UTC
                            if (nextQuizTimeStr.endsWith('Z')) {
                                nextQuizTime = new Date(nextQuizTimeStr).getTime();
                            } else if (nextQuizTimeStr.includes('+')) {
                                nextQuizTime = new Date(nextQuizTimeStr).getTime();
                            } else {
                                nextQuizTime = new Date(nextQuizTimeStr + 'Z').getTime();
                            }

                            // Validate the parsed time
                            if (isNaN(nextQuizTime)) {
                                throw new Error('Invalid date parsing result');
                            }

                        } catch (parseError) {
                            console.error('❌ Error parsing Learn & Earn next quiz time:', parseError);
                            console.error('Original timestamp:', nextQuizTimeStr);
                            nextQuizTime = Date.now() + (24 * 60 * 60 * 1000); // Fallback to 24 hours from now
                        }

                        console.log('Learn & Earn Timer Setup (Fixed):');
                        console.log('Backend next_quiz_time:', nextQuizTimeStr);
                        console.log('Parsed nextQuizTime (UTC):', new Date(nextQuizTime).toISOString());
                        console.log('Current time (UTC):', new Date().toISOString());
                        console.log('Time difference (hours):', (nextQuizTime - Date.now()) / (1000 * 60 * 60));

                        const updateCountdown = () => {
                            const now = Date.now();
                            const currentRemaining = Math.max(0, nextQuizTime - now);

                            // Calculate hours, minutes, and seconds properly
                            const totalHours = Math.floor(currentRemaining / (1000 * 60 * 60));
                            const minutes = Math.floor((currentRemaining % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((currentRemaining % (1000 * 60)) / 1000);

                            let countdownText;
                            if (currentRemaining <= 0) {
                                countdownText = 'Quiz available now! 🎯';
                            } else if (totalHours > 0) {
                                countdownText = `Next quiz available in ${totalHours}h ${minutes}m`;
                            } else if (minutes > 0) {
                                countdownText = `Next quiz available in ${minutes}m ${seconds}s`;
                            } else {
                                countdownText = `Next quiz available in ${seconds}s`;
                            }

                            const countdownEl = document.getElementById('learnEarnCountdown');
                            if (countdownEl) {
                                countdownEl.textContent = countdownText;
                            }

                            if (currentRemaining <= 0) {
                                clearInterval(countdownInterval);
                                // Re-check eligibility after countdown ends
                                setTimeout(() => {
                                    checkLearnEarnEligibility();
                                }, 2000);
                            }
                        };

                        updateCountdown(); // Initial call
                        const countdownInterval = setInterval(updateCountdown, 1000); // Update every second
                    } else {
                        document.getElementById('learnEarnCountdown').textContent = 'Could not determine cooldown time.';
                    }
                } else {
                    // Handle other cases, e.g., Learn & Earn not available
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">❓</div>
                            <h3 style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">Learn & Earn Unavailable</h3>
                            <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                                The Learn & Earn feature is not available at the moment. Please try again later.
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error checking Learn & Earn eligibility:', error);
                document.getElementById('learnEarnContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                        <h3 style="color: #f87171; margin-bottom: 1rem;">Error Loading Feature</h3>
                        <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                            Could not load Learn & Earn information. Please check your connection and try again.
                        </p>
                    </div>
                `;
            }
        }

        // Legacy function for backward compatibility
        function startLearnEarnCountdown(nextQuizTimeStr) {
            // Redirect to the new Supabase-synced function
            startLearnEarnCountdownFromSupabase(nextQuizTimeStr);
        }

        async function submitQuiz(sessionId, answers) {
            try {
                // Stop any running timer
                if (typeof stopQuestionTimer === 'function') {
                    stopQuestionTimer();
                }

                const content = document.getElementById('learnEarnContent');
                content.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                        <p>Processing your quiz results...</p>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                            The GIMT team are processing your request, please wait a few seconds...
                        </p>
                    </div>
                `;

                const response = await fetch('/learn-earn/submit-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quiz_session_id: sessionId,
                        answers: answers
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const percentage = Math.round((result.score / result.total_questions) * 100);
                    content.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🎉</div>
                            <h3>Quiz Completed!</h3>
                            <div style="margin: 2rem 0;">
                                <div style="font-size: 2rem; color: #4ade80; margin-bottom: 0.5rem;">
                                    ${result.score}/${result.total_questions} Correct
                                </div>
                                <div style="font-size: 1.2rem; color: rgba(255, 255, 255, 0.8);">
                                    Score: ${percentage}%
                                </div>
                                <div style="font-size: 1.5rem; color: #fbbf24; margin-top: 1rem;">
                                    Earned: ${result.rewards} G$
                                </div>
                                ${result.transaction_hash ? `
                                    <div style="margin-top: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        Transaction: ${result.transaction_hash.substring(0, 10)}...${result.transaction_hash.substring(result.transaction_hash.length - 8)}
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="showLearnEarnHistory()" style="
                                background: linear-gradient(45deg, #4facfe, #00f2fe);
                                border: none;
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 0.5rem;
                            ">View History</button>
                            <button onclick="this.closest('div').parentElement.parentElement.remove()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 0.5rem;
                            ">Close</button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                            <h3>Quiz Failed</h3>
                            <p>${result.message}</p>
                            <button onclick="this.closest('div').parentElement.parentElement.remove()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                            ">Close</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Submit quiz error:', error);
                alert('❌ Failed to submit quiz. Please try again.');
            }
        }

        function showQuizQuestions(quizSession) {
            const content = document.getElementById('learnEarnContent');
            const questions = quizSession.questions;
            let currentQuestion = 0;
            let userAnswers = [];
            let questionTimer = null;
            let timeLeft = 20; // 20 seconds per question

            function displayQuestion() {
                const q = questions[currentQuestion];
                timeLeft = 20; // Reset timer for new question

                content.innerHTML = `
                    <div style="text-align: center;">
                        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: rgba(255, 255, 255, 0.7);">Question ${currentQuestion + 1} of ${questions.length}</span>
                            <div id="timer" style="
                                background: linear-gradient(45deg, #ff6b6b, #feca57);
                                color: white;
                                padding: 0.5rem 1rem;
                                border-radius: 20px;
                                font-weight: bold;
                                font-size: 1.1rem;
                                animation: pulse 1s ease-in-out infinite alternate;
                            ">
                                ⏰ ${timeLeft}s
                            </div>
                        </div>
                        <h3 style="margin-bottom: 2rem;">${q.question}</h3>
                        <div id="optionsContainer" style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                            ${q.options.map((option, index) => `
                                <button onclick="selectAnswer(${index})" class="quiz-option" data-index="${index}" style="
                                    background: rgba(255, 255, 255, 0.1);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    color: white;
                                    padding: 1rem;
                                    border-radius: 12px;
                                    cursor: pointer;
                                    text-align: left;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" 
                                   onmouseout="if(!this.classList.contains('selected')) this.style.background='rgba(255, 255, 255, 0.1)'">
                                    ${String.fromCharCode(65 + index)}. ${option}
                                </button>
                            `).join('')}
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <button onclick="previousQuestion()" ${currentQuestion === 0 ? 'disabled' : ''} style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 0.8rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                            ">Previous</button>
                            <button onclick="nextQuestion()" id="nextBtn" disabled style="
                                background: linear-gradient(45deg, #4facfe, #00f2fe);
                                border: none;
                                color: white;
                                padding: 0.8rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                opacity: 0.5;
                            ">${currentQuestion === questions.length - 1 ? 'Submit Quiz' : 'Next'}</button>
                        </div>
                    </div>
                `;

                // Start the timer
                startQuestionTimer();
            }

            function startQuestionTimer() {
                // Clear any existing timer
                if (questionTimer) {
                    clearInterval(questionTimer);
                }

                questionTimer = setInterval(() => {
                    timeLeft--;
                    const timerEl = document.getElementById('timer');

                    if (timerEl) {
                        timerEl.innerHTML = `⏰ ${timeLeft}s`;

                        // Change timer color when time is running out
                        if (timeLeft <= 5) {
                            timerEl.style.background = 'linear-gradient(45deg, #ff4757, #ff3838)';
                            timerEl.style.animation = 'pulse 0.5s ease-in-out infinite alternate';
                        } else if (timeLeft <= 10) {
                            timerEl.style.background = 'linear-gradient(45deg, #ffa726, #ff9800)';
                        }
                    }

                    // Auto-advance when timer reaches 0
                    if (timeLeft <= 0) {
                        clearInterval(questionTimer);

                        // If no answer selected, mark as -1 (no answer)
                        if (userAnswers[currentQuestion] === undefined) {
                            userAnswers[currentQuestion] = -1;
                        }

                        // Auto-proceed to next question or submit
                        setTimeout(() => {
                            if (currentQuestion < questions.length - 1) {
                                currentQuestion++;
                                displayQuestion();
                            } else {
                                // Submit quiz automatically
                                submitQuiz(quizSession.session_id, userAnswers);
                            }
                        }, 1000); // 1 second delay before auto-advancing

                        // Show time's up message
                        if (timerEl) {
                            timerEl.innerHTML = '⏰ Time\'s Up!';
                            timerEl.style.background = 'linear-gradient(45deg, #ff4757, #c44569)';
                        }
                    }
                }, 1000);
            }

            function stopQuestionTimer() {
                if (questionTimer) {
                    clearInterval(questionTimer);
                    questionTimer = null;
                }
            }

            window.selectAnswer = function(answerIndex) {
                // Prevent multiple selections
                if (userAnswers[currentQuestion] !== undefined) {
                    return;
                }

                userAnswers[currentQuestion] = answerIndex;

                // Stop the timer
                stopQuestionTimer();

                // Highlight selected answer
                document.querySelectorAll('.quiz-option').forEach((btn, index) => {
                    btn.style.pointerEvents = 'none'; // Disable all buttons
                    if (index === answerIndex) {
                        btn.style.background = 'rgba(79, 172, 254, 0.5)';
                        btn.style.borderColor = '#4facfe';
                        btn.classList.add('selected');
                        btn.style.transform = 'scale(1.02)';
                    } else {
                        btn.style.background = 'rgba(255, 255, 255, 0.05)';
                        btn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                        btn.style.opacity = '0.6';
                    }
                });

                // Update timer to show "Selected!"
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.innerHTML = '✅ Selected!';
                    timerEl.style.background = 'linear-gradient(45deg, #2ed573, #1e90ff)';
                    timerEl.style.animation = 'none';
                }

                // Auto-proceed to next question after 1.5 seconds
                setTimeout(() => {
                    if (currentQuestion < questions.length - 1) {
                        currentQuestion++;
                        displayQuestion();
                    } else {
                        // Submit quiz
                        submitQuiz(quizSession.session_id, userAnswers);
                    }
                }, 1500);
            };

            window.nextQuestion = function() {
                // Only allow manual next if answer is selected
                if (userAnswers[currentQuestion] === undefined) {
                    alert('Please select an answer first!');
                    return;
                }

                stopQuestionTimer();

                if (currentQuestion < questions.length - 1) {
                    currentQuestion++;
                    displayQuestion();
                } else {
                    // Submit quiz
                    submitQuiz(quizSession.session_id, userAnswers);
                }
            };

            window.previousQuestion = function() {
                if (currentQuestion > 0) {
                    stopQuestionTimer();
                    currentQuestion--;
                    displayQuestion();
                }
            };

            displayQuestion();
        }

        async function startLearnEarnQuiz() {
            try {
                const response = await fetch('/learn-earn/start-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Show quiz questions
                    showQuizQuestions(data.quiz_session);
                } else {
                    alert(`❌ ${data.error}`);
                }
            } catch (error) {
                console.error('Start quiz error:', error);
                alert('❌ Failed to start quiz. Please try again.');
            }
        }

        async function showLearnEarnQuiz() {
            // Create a modal for Learn & Earn
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80%;
                    overflow-y: auto;
                    color: white;
                    position: relative;
                ">
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 1.2rem;
                    ">×</button>

                    <h2 style="text-align: center; margin-bottom: 1.5rem;">📚 Learn & Earn Quiz</h2>

                    <div id="learnEarnContent">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">🎯</div>
                            <p>Ready to test your knowledge and earn G$ rewards?</p>
                            <div style="margin: 1.5rem 0;">
                                <strong>Quiz Details:</strong><br>
                                • 10 questions about GoodDollar<br>
                                • 200 G$ per correct answer<br>
                                • Maximum reward: 2000 G$<br>
                                • 24-hour cooldown between quizzes
                            </div>
                            <button onclick="startLearnEarnQuiz()" style="
                                background: linear-gradient(45deg, #4facfe, #00f2fe);
                                border: none;
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 1rem;
                            ">Start Quiz</button>
                            <button onclick="showLearnEarnHistory()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 1rem;
                            ">View History</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function showLearnEarnHistory() {
            try {
                const response = await fetch('/learn-earn/quiz-history?limit=50');
                const data = await response.json();

                console.log('Learn & Earn History Response:', data);

                const content = document.getElementById('learnEarnContent');

                if (data.success && data.quiz_history.length > 0) {
                    const historyHTML = data.quiz_history.map(quiz => {
                        const date = new Date(quiz.timestamp);
                        const percentage = Math.round((quiz.score / quiz.total_questions) * 100);

                        return `
                            <div style="
                                background: rgba(255, 255, 255, 0.1);
                                border: 1px solid rgba(255, 255, 255, 0.2);
                                border-radius: 12px;
                                padding: 1.5rem;
                                margin-bottom: 1rem;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: #4ade80;">
                                        +${quiz.amount_g$} G$
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        ${date.toLocaleDateString()} ${date.toLocaleTimeString()}
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.6);">Score</div>
                                        <div>${quiz.score}/${quiz.total_questions} (${percentage}%)</div>
                                    </div>
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.6);">Reward</div>
                                        <div>${quiz.amount_g$} G$</div>
                                    </div>
                                    ${quiz.transaction_hash ? `
                                        <div>
                                            <div style="color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                            <div style="font-family: monospace; font-size: 0.8rem; cursor: pointer; color: #60a5fa;" 
                                                 onclick="window.open('https://explorer.celo.org/mainnet/tx/${quiz.transaction_hash}', '_blank')">
                                                ${quiz.transaction_hash.substring(0, 8)}...${quiz.transaction_hash.substring(quiz.transaction_hash.length - 6)}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = `
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3>📚 Learn & Earn History</h3>
                                <button onclick="showLearnEarnQuiz()" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    color: white;
                                    padding: 0.5rem 1rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 0.9rem;
                                ">← Back</button>
                            </div>

                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; text-align: center;">
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #4ade80;">${data.stats.total_quizzes_completed}</div>
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Quizzes Completed</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #fbbf24;">${data.stats.total_g_earned}</div>
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Total G$ Earned</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #60a5fa;">${data.stats.average_score_percentage}%</div>
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Average Score</div>
                                    </div>
                                </div>
                            </div>

                            <div style="max-height: 400px; overflow-y: auto;">
                                ${historyHTML}
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h3>📚 Learn & Earn History</h3>
                                <button onclick="showLearnEarnQuiz()" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    color: white;
                                    padding: 0.5rem 1rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 0.9rem;
                                ">← Back</button>
                            </div>
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📚</div>
                            <div>No quiz history yet</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem; color: rgba(255, 255, 255, 0.7);">
                                Take your first quiz to start earning G$ rewards!
                            </div>
                            <button onclick="showLearnEarnQuiz()" style="
                                background: linear-gradient(45deg, #4facfe, #00f2fe);
                                border: none;
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin-top: 1.5rem;
                            ">Take Quiz Now</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('History error:', error);
                alert('❌ Failed to load history. Please try again.');
            }
        }

        async function openLearnEarn() {
            try {
                // Check eligibility first
                const response = await fetch('/learn-earn/eligibility');
                const data = await response.json();

                if (data.success && data.eligible) {
                    // User is eligible, show quiz interface
                    showLearnEarnQuiz();
                } else if (data.blocked && data.next_quiz_time) {
                    // Show cooldown message with proper UTC timezone handling - FIXED
                    let nextTimeStr = data.next_quiz_time;

                    // Parse the datetime string correctly - UTC TIMEZONE FIXED
                    let nextQuizTime;
                    if (nextTimeStr.endsWith('Z')) {
                        nextQuizTime = new Date(nextTimeStr);
                    } else if (nextTimeStr.includes('+')) {
                        nextQuizTime = new Date(nextTimeStr);
                    } else {
                        nextQuizTime = new Date(nextTimeStr + 'Z');
                    }

                    const now = new Date();
                    const diff = nextQuizTime - now;

                    console.log('Learn & Earn Alert Countdown Debug (Fixed):');
                    console.log('Backend next_quiz_time:', data.next_quiz_time);
                    console.log('Parsed nextQuizTime (UTC):', nextQuizTime.toISOString());
                    console.log('Current time (UTC):', now.toISOString());
                    console.log('Time difference (ms):', diff);
                    console.log('Time difference (hours):', diff / (1000 * 60 * 60));

                    if (diff > 0) {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        alert(`📚 Learn & Earn Quiz\n\n⏰ You can take the next quiz in ${hours}h ${minutes}m\n\n${data.message}`);
                    } else {
                        alert('📚 Quiz available! Refreshing...');
                        location.reload();
                    }
                } else {
                    alert('📚 Learn & Earn not available at the moment. Please try again later.');
                }
            } catch (error) {
                console.error('Learn & Earn error:', error);
                alert('📚 Error loading Learn & Earn. Please try again.');
            }
        }

        async function checkLearnEarnEligibility() {
            try {
                const response = await fetch('/learn-earn/eligibility');
                const eligibilityData = await response.json();
                learnEarnData = eligibilityData; // Update learnEarnData

                const content = document.getElementById('learnEarnContent');

                if (eligibilityData.success && eligibilityData.eligible) {
                    // User is eligible, show the quiz start interface
                    content.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">🎯</div>
                            <p>Ready to test your knowledge and earn G$ rewards?</p>
                            <div style="margin: 1.5rem 0;">
                                <strong>Quiz Details:</strong><br>
                                • 10 questions about GoodDollar<br>
                                • 200 G$ per correct answer<br>
                                • Maximum reward: 2000 G$<br>
                                • 24-hour cooldown between quizzes
                            </div>
                            <button onclick="startLearnEarnQuiz()" style="
                                background: linear-gradient(45deg, #4facfe, #00f2fe);
                                border: none;
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 1rem;
                            ">Start Quiz</button>
                            <button onclick="showLearnEarnHistory()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                cursor: pointer;
                                font-size: 1.1rem;
                                font-weight: 600;
                                margin: 1rem;
                            ">View History</button>
                        </div>
                    `;
                } else if (eligibilityData.blocked) {
                    // User is blocked due to cooldown, show the cooldown message
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">⏰</div>
                            <h3 style="color: #fbbf24; margin-bottom: 1rem;">24-Hour Quiz Cooldown Active</h3>
                            <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                                You have completed a quiz recently. Please wait 24 hours before taking another quiz.
                            </p>
                            <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">⏱️ Cooldown Period: 24 Hours</div>
                                <div id="learnEarnCountdown">Calculating...</div>
                            </div>
                            <button onclick="showLearnEarnHistory()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                padding: 0.75rem 1.5rem;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 0.95rem;
                            ">View Quiz History</button>
                        </div>
                    `;

                    // Start the countdown timer for the cooldown
                    if (eligibilityData.next_quiz_time) {
                        const nextQuizTimeStr = eligibilityData.next_quiz_time;
                        let nextQuizTime;

                        // Parse the datetime string correctly - UTC TIMEZONE FIXED
                        try {
                            // Backend sends UTC timestamps with 'Z' suffix - parse as UTC
                            if (nextQuizTimeStr.endsWith('Z')) {
                                nextQuizTime = new Date(nextQuizTimeStr).getTime();
                            } else if (nextQuizTimeStr.includes('+')) {
                                nextQuizTime = new Date(nextQuizTimeStr).getTime();
                            } else {
                                nextQuizTime = new Date(nextQuizTimeStr + 'Z').getTime();
                            }

                            // Validate the parsed time
                            if (isNaN(nextQuizTime)) {
                                throw new Error('Invalid date parsing result');
                            }

                        } catch (parseError) {
                            console.error('❌ Error parsing Learn & Earn next quiz time:', parseError);
                            console.error('Original timestamp:', nextQuizTimeStr);
                            nextQuizTime = Date.now() + (24 * 60 * 60 * 1000); // Fallback to 24 hours from now
                        }

                        console.log('Learn & Earn Timer Setup (Fixed):');
                        console.log('Backend next_quiz_time:', nextQuizTimeStr);
                        console.log('Parsed nextQuizTime (UTC):', new Date(nextQuizTime).toISOString());
                        console.log('Current time (UTC):', new Date().toISOString());
                        console.log('Time difference (hours):', (nextQuizTime - Date.now()) / (1000 * 60 * 60));

                        const updateCountdown = () => {
                            const now = Date.now();
                            const currentRemaining = Math.max(0, nextQuizTime - now);

                            // Calculate hours, minutes, and seconds properly
                            const totalHours = Math.floor(currentRemaining / (1000 * 60 * 60));
                            const minutes = Math.floor((currentRemaining % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((currentRemaining % (1000 * 60)) / 1000);

                            let countdownText;
                            if (currentRemaining <= 0) {
                                countdownText = 'Quiz available now! 🎯';
                            } else if (totalHours > 0) {
                                countdownText = `Next quiz available in ${totalHours}h ${minutes}m`;
                            } else if (minutes > 0) {
                                countdownText = `Next quiz available in ${minutes}m ${seconds}s`;
                            } else {
                                countdownText = `Next quiz available in ${seconds}s`;
                            }

                            const countdownEl = document.getElementById('learnEarnCountdown');
                            if (countdownEl) {
                                countdownEl.textContent = countdownText;
                            }

                            if (currentRemaining <= 0) {
                                clearInterval(countdownInterval);
                                // Re-check eligibility after countdown ends
                                setTimeout(() => {
                                    checkLearnEarnEligibility();
                                }, 2000);
                            }
                        };

                        updateCountdown(); // Initial call
                        const countdownInterval = setInterval(updateCountdown, 1000); // Update every second
                    } else {
                        document.getElementById('learnEarnCountdown').textContent = 'Could not determine cooldown time.';
                    }
                } else {
                    // Handle other cases, e.g., Learn & Earn not available
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">❓</div>
                            <h3 style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">Learn & Earn Unavailable</h3>
                            <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                                The Learn & Earn feature is not available at the moment. Please try again later.
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error checking Learn & Earn eligibility:', error);
                document.getElementById('learnEarnContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                        <h3 style="color: #f87171; margin-bottom: 1rem;">Error Loading Feature</h3>
                        <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                            Could not load Learn & Earn information. Please check your connection and try again.
                        </p>
                    </div>
                `;
            }
        }

        // Referral Program functions
        async function openReferralProgram() {
            try {
                // Check if user is authenticated
                const response = await fetch('/api/referral/status');

                if (!response.ok) {
                    alert('🔗 Please login first to access the Referral Program');
                    return;
                }

                // Show referral program modal
                showReferralProgramModal();
            } catch (error) {
                console.error('Referral program error:', error);
                alert('🔗 Error loading Referral Program. Please try again.');
            }
        }

        async function showReferralProgramModal() {
            // Create referral program modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    padding: 2rem;
                    color: white;
                    position: relative;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                ">
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: rgba(255, 255, 255, 0.1);
                        border: none;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        font-size: 1.2rem;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">×</button>

                    <h2 style="
                        margin: 0 0 2rem 0;
                        font-size: 1.8rem;
                        background: linear-gradient(45deg, #4facfe, #00f2fe);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        text-align: center;
                    ">🔗 Referral Program</h2>

                    <div id="referralContent">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                            <p>Loading referral program...</p>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('modal');
            document.body.appendChild(modal);

            // Load referral program content
            loadReferralProgramContent();
        }

        async function loadReferralProgramContent() {
            try {
                const response = await fetch('/api/referral/status');
                const data = await response.json();

                const content = document.getElementById('referralContent');

                if (data.eligibility && data.stats) {
                    const stats = data.stats;
                    const eligibility = data.eligibility;

                    content.innerHTML = `
                        <div style="margin-bottom: 2rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #4ade80;">${stats.total_referrals}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Total Referrals</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #fbbf24;">${stats.total_earned} G$</div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Total Earned</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #60a5fa;">${stats.bonus_per_referral} G$</div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Per Referral</div>
                                </div>
                            </div>

                            ${eligibility.has_bonuses ? `
                                <div style="background: rgba(74, 222, 128, 0.2); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; text-align: center;">
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #4ade80; margin-bottom: 0.5rem;">
                                        🎉 ${eligibility.unclaimed_count} Unclaimed Bonuses Available!
                                    </div>
                                    <div style="color: rgba(255, 255, 255, 0.9); margin-bottom: 1rem;">
                                        Total: ${eligibility.total_bonus} G$
                                    </div>
                                    <button onclick="claimReferralBonus()" style="
                                        background: linear-gradient(45deg, #4ade80, #10b981);
                                        border: none;
                                        color: white;
                                        padding: 0.8rem 1.5rem;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-weight: 600;
                                    ">Claim ${eligibility.total_bonus} G$</button>
                                </div>
                            ` : `
                                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; text-align: center;">
                                    <div style="color: rgba(255, 255, 255, 0.7);">No unclaimed bonuses available</div>
                                </div>
                            `}

                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: #4facfe;">Your Referral Link</h3>
                                ${stats.referral_link ? `
                                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                                        <div style="font-family: monospace; font-size: 0.9rem; word-break: break-all; margin-bottom: 1rem; color: rgba(255, 255, 255, 0.9);">
                                            ${stats.referral_link}
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                            <button onclick="copyReferralLink('${stats.referral_link}')" style="
                                                background: rgba(255, 255, 255, 0.2);
                                                border: 1px solid rgba(255, 255, 255, 0.3);
                                                color: white;
                                                padding: 0.5rem 1rem;
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-size: 0.9rem;
                                            ">📋 Copy Link</button>
                                            <button onclick="shareReferralLink('${stats.referral_link}')" style="
                                                background: rgba(255, 255, 255, 0.2);
                                                border: 1px solid rgba(255, 255, 255, 0.3);
                                                color: white;
                                                padding: 0.5rem 1rem;
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-size: 0.9rem;
                                            ">📤 Share</button>
                                        </div>
                                    </div>
                                ` : `
                                    <button onclick="createReferralLink()" style="
                                        background: linear-gradient(45deg, #4facfe, #00f2fe);
                                        border: none;
                                        color: white;
                                        padding: 1rem 2rem;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        width: 100%;
                                    ">Create Referral Link</button>
                                `}
                            </div>

                            <div style="text-align: center;">
                                <button onclick="showReferralHistory()" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    color: white;
                                    padding: 0.8rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                ">View Referral History</button>
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                            <h3 style="color: #f87171; margin-bottom: 1rem;">Error Loading Referral Program</h3>
                            <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                                Could not load referral program data. Please check your connection and try again.
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Referral program content error:', error);
                document.getElementById('referralContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                        <h3 style="color: #f87171; margin-bottom: 1rem;">Error Loading Feature</h3>
                        <p style="margin-bottom: 1.5rem; opacity: 0.9;">
                            Could not load referral program information. Please check your connection and try again.
                        </p>
                    </div>
                `;
            }
        }

        async function createReferralLink() {
            try {
                const response = await fetch('/api/referral/create-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`🎉 Referral link created successfully!\n\nCode: ${result.referral_code}\n\nShare this link to earn 100 G$ per referral!`);
                    // Reload the referral program content
                    loadReferralProgramContent();
                } else {
                    alert(`❌ Failed to create referral link: ${result.error}`);
                }
            } catch (error) {
                console.error('Create referral link error:', error);
                alert('❌ Network error. Please try again.');
            }
        }

        async function claimReferralBonus() {
            try {
                const response = await fetch('/api/referral/claim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`🎉 Referral bonus claimed successfully!\n\nAmount: ${result.bonus_amount} G$\nReferrals: ${result.referral_count}\n\nTransaction: ${result.tx_hash}`);
                    // Reload the referral program content
                    loadReferralProgramContent();
                } else {
                    alert(`❌ Failed to claim bonus: ${result.error}`);
                }
            } catch (error) {
                console.error('Claim referral bonus error:', error);
                alert('❌ Network error. Please try again.');
            }
        }

        function copyReferralLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('📋 Referral link copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('📋 Referral link copied to clipboard!');
            });
        }

        function shareReferralLink(link) {
            if (navigator.share) {
                navigator.share({
                    title: 'Join GoodDollar and Earn G$!',
                    text: 'Join me on GoodDollar and start earning Universal Basic Income in G$ tokens!',
                    url: link
                });
            } else {
                copyReferralLink(link);
            }
        }

        async function showReferralHistory() {
            try {
                const response = await fetch('/api/referral/history?limit=20');
                const data = await response.json();

                const content = document.getElementById('referralContent');

                if (data.success && data.history.length > 0) {
                    const historyHTML = data.history.map(referral => {
                        const date = new Date(referral.referred_at);
                        const status = referral.bonus_claimed ? 'Bonus Claimed' : 'Pending Verification';
                        const statusColor = referral.bonus_claimed ? '#4ade80' : '#fbbf24';

                        return `
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 12px;
                                padding: 1.5rem;
                                margin-bottom: 1rem;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: ${statusColor};">
                                        ${referral.bonus_claimed ? `+${referral.bonus_amount} G$` : 'Pending'}
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        ${date.toLocaleDateString()} ${date.toLocaleTimeString()}
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.6);">Referred Wallet</div>
                                        <div style="font-family: monospace; font-size: 0.8rem;">${referral.referred_wallet}</div>
                                    </div>
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.6);">Code</div>
                                        <div>${referral.referral_code}</div>
                                    </div>
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.6);">Status</div>
                                        <div style="color: ${statusColor};">${status}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = `
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h3>🔗 Referral History</h3>
                                <button onclick="loadReferralProgramContent()" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    color: white;
                                    padding: 0.5rem 1rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 0.9rem;
                                ">← Back</button>
                            </div>

                            <div style="max-height: 400px; overflow-y: auto;">
                                ${historyHTML}
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h3>🔗 Referral History</h3>
                                <button onclick="loadReferralProgramContent()" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    color: white;
                                    padding: 0.5rem 1rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 0.9rem;
                                ">← Back</button>
                            </div>
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">🔗</div>
                            <div>No referrals yet</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem; color: rgba(255, 255, 255, 0.7);">
                                Share your referral link to start earning!
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Referral history error:', error);
                alert('❌ Failed to load referral history. Please try again.');
            }
        }

        // Hamburger menu toggle function
        function toggleMenu() {
            const navMenu = document.getElementById('navMenu');
            const menuIcon = document.getElementById('menuIcon');

            navMenu.classList.toggle('active');

            // Animate hamburger icon
            if (navMenu.classList.contains('active')) {
                menuIcon.innerHTML = '✕';
            } else {
                menuIcon.innerHTML = '☰';
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navMenu = document.getElementById('navMenu');
            const menuToggle = document.querySelector('.menu-toggle');
            const navbar = document.querySelector('.navbar');

            if (navMenu.classList.contains('active') && 
                !navbar.contains(event.target)) {
                navMenu.classList.remove('active');
                document.getElementById('menuIcon').innerHTML = '☰';
            }

            // Close actions dropdown when clicking outside
            const actionsDropdown = document.getElementById('actionsDropdown');
            const actionsMenuContainer = document.querySelector('.actions-menu-container');

            if (actionsDropdown && actionsMenuContainer && 
                actionsDropdown.style.display === 'block' && 
                !actionsMenuContainer.contains(event.target)) {
                actionsDropdown.style.display = 'none';
                document.getElementById('menuArrow').style.transform = 'rotate(0deg)';
            }
        });

        // Toggle actions menu dropdown
        function toggleActionsMenu() {
            const dropdown = document.getElementById('actionsDropdown');
            const arrow = document.getElementById('menuArrow');

            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                dropdown.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            }
        }

        // Filter actions by category
        function filterActions(category) {
            const allCards = document.querySelectorAll('.action-card');
            const menuItems = document.querySelectorAll('.menu-item');

            // Update menu item styling
            menuItems.forEach(item => {
                if (item.onclick && item.onclick.toString().includes(category)) {
                    item.style.background = 'linear-gradient(45deg, #4facfe, #00f2fe)';
                    item.classList.add('active');
                } else {
                    item.style.background = 'transparent';
                    item.classList.remove('active');
                }
            });

            // Filter action cards
            allCards.forEach(card => {
                if (category === 'all') {
                    card.style.display = 'block';
                } else {
                    const cardCategory = card.getAttribute('data-category');
                    if (cardCategory === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });

            // Close dropdown after selection
            document.getElementById('actionsDropdown').style.display = 'none';
            document.getElementById('menuArrow').style.transform = 'rotate(0deg)';

            // Update button text
            const categoryNames = {
                'all': '🌟 All Actions',
                'earning': '💰 Earning & Rewards',
                'financial': '💳 Financial Services',
                'social': '👥 Social & Community',
                'analytics': '📊 Analytics & Tracking'
            };

            document.querySelector('.actions-menu-toggle span').textContent = categoryNames[category] || '📋 Choose Category';
        }

        // Forum Notifications System
        async function loadForumNotifications() {
            try {
                const response = await fetch('/api/forum/notifications');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Forum Notifications Data:', data);

                if (data.success) {
                    updateNotificationUI(data);
                } else {
                    console.error('Forum notifications error:', data.error);
                }
            } catch (error) {
                console.error('Failed to load forum notifications:', error);
                // Don't show error to user, just log it
            }
        }

        function updateNotificationUI(data) {
            const summary = data.summary || {};
            const notifications = data.notifications || [];

            // Update forum rewards stat card
            const rewardsValue = document.getElementById('forumRewardsValue');
            const rewardsDesc = document.getElementById('forumRewardsDesc');
            const notificationBadge = document.getElementById('notificationBadge');

            if (summary.week_amount > 0) {
                rewardsValue.textContent = `${summary.week_amount} G$`;
                rewardsDesc.textContent = `${summary.week_count} rewards this week`;
            } else {
                rewardsValue.textContent = '0 G$';
                rewardsDesc.textContent = 'No recent forum rewards';
            }

            // Show notification badge if there are recent rewards
            if (summary.has_new_rewards && summary.recent_count > 0) {
                notificationBadge.textContent = summary.recent_count;
                notificationBadge.style.display = 'flex';
                notificationBadge.style.animation = 'pulse 2s ease-in-out infinite';
            } else {
                notificationBadge.style.display = 'none';
            }

            // Store notifications data for modal
            window.forumNotificationsData = data;
        }

        async function showForumNotifications() {
            const data = window.forumNotificationsData;

            if (!data || !data.success) {
                alert('No forum notifications available at the moment.');
                return;
            }

            const notifications = data.notifications || [];
            const summary = data.summary || {};
            const activityFeed = data.activity_feed || [];

            // Create notifications modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;

            const notificationsHTML = notifications.length > 0 ? 
                notifications.map(notif => `
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" 
                       onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <div style="font-size: 1.5rem;">🎉</div>
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #4ade80;">
                                        +${notif.amount} G$
                                    </div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                        ${notif.title}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                                    ${formatNotificationTime(notif.timestamp)}
                                </div>
                                <div style="
                                    padding: 0.2rem 0.6rem;
                                    border-radius: 15px;
                                    font-size: 0.7rem;
                                    font-weight: 600;
                                    background: rgba(74, 222, 128, 0.2);
                                    color: #4ade80;
                                    border: 1px solid rgba(74, 222, 128, 0.3);
                                    margin-top: 0.3rem;
                                ">New</div>
                            </div>
                        </div>
                        <div style="color: rgba(255, 255, 255, 0.8); margin-bottom: 0.8rem;">
                            ${notif.message}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; font-size: 0.9rem;">
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Post ID</div>
                                <div><a href="/forum/post/${notif.post_id}" style="color: #60a5fa; text-decoration: none;">#${notif.post_id}</a></div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">New Likes</div>
                                <div>${notif.new_likes}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Total Likes</div>
                                <div>${notif.total_likes}</div>
                            </div>
                            <div>
                                <div style="color: rgba(255, 255, 255, 0.6);">Transaction</div>
                                <div style="
                                    font-family: monospace; 
                                    font-size: 0.8rem; 
                                    cursor: pointer; 
                                    color: #60a5fa;
                                    text-decoration: underline;
                                    word-break: break-all;
                                " onclick="window.open('https://explorer.celo.org/mainnet/tx/${notif.transaction_hash}', '_blank')" 
                                   title="View on Celo Explorer">
                                    ${notif.transaction_hash.substring(0, 8)}...${notif.transaction_hash.substring(notif.transaction_hash.length - 6)}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('') : 
                `<div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.7);">
                    <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">🔔</div>
                    <div>No forum reward notifications yet</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                        Post in the community forum to start earning rewards!
                    </div>
                </div>`;

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f4c75 100%);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 700px;
                    max-height: 80vh;
                    overflow-y: auto;
                    padding: 2rem;
                    color: white;
                    position: relative;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                ">
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: rgba(255, 255, 255, 0.1);
                        border: none;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        font-size: 1.2rem;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">×</button>

                    <h2 style="
                        margin: 0 0 2rem 0;
                        font-size: 1.8rem;
                        background: linear-gradient(45deg, #4facfe, #00f2fe);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        text-align: center;
                    ">💬 Forum Reward Notifications</h2>

                    <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #4ade80;">${summary.recent_count || 0}</div>
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">New (24h)</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #fbbf24;">${summary.recent_amount || 0} G$</div>
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Recent Earned</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #60a5fa;">${summary.week_count || 0}</div>
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">This Week</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #a78bfa;">${summary.week_amount || 0} G$</div>
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Week Total</div>
                            </div>
                        </div>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto;">
                        ${notificationsHTML}
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <a href="/forum" style="
                            background: linear-gradient(45deg, #4facfe, #00f2fe);
                            border: none;
                            color: white;
                            padding: 0.8rem 1.5rem;
                            border-radius: 8px;
                            text-decoration: none;
                            font-weight: 600;
                            display: inline-block;
                        ">Visit Community Forum</a>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Hide notification badge after viewing
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                badge.style.display = 'none';
            }
        }

        function formatNotificationTime(timestamp) {
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                return `${Math.floor(diff / 86400000)}d ago`;
            } catch (e) {
                return 'Recently';
            }
        }

        // Simple Christmas theme - no heavy animations
        console.log('🎄 Simple Christmas theme loaded');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
